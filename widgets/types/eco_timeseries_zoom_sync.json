{
  "fqn": "eco_custom_widgets.eco_timeseries_zoom_sync",
  "name": "Synced Zoom Time Series",
  "deprecated": false,
  "image": "tb-image;/api/images/system/chart.svg",
  "description": "Time series chart with synchronized zoom. When you zoom on this chart, all widgets using dashboard timewindow zoom together. Supports line, bar, and area chart types.",
  "descriptor": {
    "type": "timeseries",
    "sizeX": 8,
    "sizeY": 5,
    "resources": [
      {
        "url": "https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"
      }
    ],
    "templateHtml": "<div id=\"sync-chart-container\" style=\"width: 100%; height: 100%;\"></div>",
    "templateCss": "#sync-chart-container { position: relative; }",
    "controllerScript": "var chart = null;\nvar chartContainer = null;\nvar zoomDebounceTimer = null;\nvar isExternalUpdate = false;\n\nself.onInit = function() {\n    chartContainer = self.ctx.$container.find('#sync-chart-container')[0];\n    if (!chartContainer) {\n        console.error('Chart container not found');\n        return;\n    }\n    \n    if (typeof echarts === 'undefined') {\n        console.error('ECharts not loaded');\n        return;\n    }\n    \n    chart = echarts.init(chartContainer);\n    \n    // Attach zoom sync handler\n    var settings = self.ctx.settings || {};\n    if (settings.enableZoomSync !== false) {\n        chart.on('datazoom', handleZoomSync);\n    }\n    \n    updateChart();\n};\n\nfunction handleZoomSync(params) {\n    if (isExternalUpdate) return;\n    \n    var settings = self.ctx.settings || {};\n    if (settings.enableZoomSync === false) return;\n    \n    var debounceMs = settings.zoomSyncDebounce || 150;\n    \n    if (zoomDebounceTimer) {\n        clearTimeout(zoomDebounceTimer);\n    }\n    \n    zoomDebounceTimer = setTimeout(function() {\n        var option = chart.getOption();\n        var dataZoom = option.dataZoom && option.dataZoom[0];\n        if (!dataZoom) return;\n        \n        var timeWindow = self.ctx.timeWindow;\n        if (!timeWindow) return;\n        \n        var totalRange = timeWindow.maxTime - timeWindow.minTime;\n        var startPercent = dataZoom.start || 0;\n        var endPercent = dataZoom.end || 100;\n        \n        // Only sync if actually zoomed (not at 0-100%)\n        if (startPercent > 0.5 || endPercent < 99.5) {\n            var startTime = Math.round(timeWindow.minTime + (totalRange * startPercent / 100));\n            var endTime = Math.round(timeWindow.minTime + (totalRange * endPercent / 100));\n            \n            // Update dashboard timewindow - this syncs all widgets\n            if (self.ctx.dashboard && self.ctx.dashboard.onUpdateTimewindow) {\n                self.ctx.dashboard.onUpdateTimewindow(startTime, endTime);\n            }\n        }\n    }, debounceMs);\n}\n\nself.onDataUpdated = function() {\n    isExternalUpdate = true;\n    updateChart();\n    setTimeout(function() { isExternalUpdate = false; }, 100);\n};\n\nfunction updateChart() {\n    if (!chart) return;\n    \n    var settings = self.ctx.settings || {};\n    var chartType = settings.chartType || 'line';\n    var smoothLine = settings.smoothLine !== false;\n    var showDataZoomSlider = settings.showDataZoomSlider !== false;\n    var showLegend = settings.showLegend !== false;\n    var showTooltip = settings.showTooltip !== false;\n    var stack = settings.stack || false;\n    \n    var data = self.ctx.data || [];\n    if (!data.length) {\n        chart.setOption({\n            title: { text: 'No data', left: 'center', top: 'middle' }\n        });\n        return;\n    }\n    \n    // Build series from all datasources\n    var series = [];\n    var legendData = [];\n    \n    for (var i = 0; i < data.length; i++) {\n        var ds = data[i];\n        if (!ds.data || !ds.data.length) continue;\n        \n        var dataKey = ds.dataKey || {};\n        var label = dataKey.label || dataKey.name || 'Series ' + (i + 1);\n        var color = dataKey.color || getDefaultColor(i);\n        var units = dataKey.units || '';\n        \n        legendData.push(label);\n        \n        var seriesData = ds.data.map(function(d) { return [d[0], d[1]]; });\n        \n        var seriesConfig = {\n            name: label,\n            type: chartType === 'bar' ? 'bar' : 'line',\n            data: seriesData,\n            smooth: smoothLine && chartType !== 'bar',\n            symbol: chartType === 'line' ? 'none' : undefined,\n            lineStyle: { color: color, width: 2 },\n            itemStyle: { color: color }\n        };\n        \n        if (chartType === 'area') {\n            seriesConfig.type = 'line';\n            seriesConfig.areaStyle = { color: color, opacity: 0.3 };\n        }\n        \n        if (stack) {\n            seriesConfig.stack = 'total';\n            if (chartType === 'area' || chartType === 'bar') {\n                seriesConfig.areaStyle = seriesConfig.areaStyle || {};\n                seriesConfig.areaStyle.opacity = 0.7;\n            }\n        }\n        \n        series.push(seriesConfig);\n    }\n    \n    if (series.length === 0) {\n        chart.setOption({\n            title: { text: 'No valid data', left: 'center', top: 'middle' }\n        });\n        return;\n    }\n    \n    var option = {\n        tooltip: showTooltip ? {\n            trigger: 'axis',\n            axisPointer: { type: chartType === 'bar' ? 'shadow' : 'cross' },\n            formatter: function(params) {\n                if (!params || !params.length) return '';\n                var d = new Date(params[0].value[0]);\n                var result = d.toLocaleString() + '<br/>';\n                for (var i = 0; i < params.length; i++) {\n                    var p = params[i];\n                    if (p.value && p.value[1] !== null && p.value[1] !== undefined) {\n                        result += '<span style=\"display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:' + p.color + ';\"></span>';\n                        result += p.seriesName + ': ' + p.value[1].toFixed(2) + '<br/>';\n                    }\n                }\n                return result;\n            }\n        } : {},\n        legend: showLegend ? {\n            data: legendData,\n            top: 5,\n            type: legendData.length > 5 ? 'scroll' : 'plain'\n        } : {},\n        grid: {\n            left: 50,\n            right: 20,\n            top: showLegend ? 40 : 20,\n            bottom: showDataZoomSlider ? 50 : 30\n        },\n        xAxis: {\n            type: 'time',\n            axisLabel: { fontSize: 10 },\n            splitLine: { show: false }\n        },\n        yAxis: {\n            type: 'value',\n            axisLabel: { fontSize: 10 },\n            splitLine: { lineStyle: { type: 'dashed', opacity: 0.3 } }\n        },\n        dataZoom: [\n            { type: 'inside', xAxisIndex: 0 },\n            showDataZoomSlider ? { type: 'slider', xAxisIndex: 0, bottom: 5, height: 20 } : null\n        ].filter(function(x) { return x !== null; }),\n        series: series\n    };\n    \n    chart.setOption(option, true);\n}\n\nfunction getDefaultColor(index) {\n    var colors = ['#2196F3', '#4CAF50', '#FF9800', '#E91E63', '#9C27B0', '#00BCD4', '#795548', '#607D8B'];\n    return colors[index % colors.length];\n}\n\nself.onResize = function() {\n    if (chart) {\n        chart.resize();\n    }\n};\n\nself.onDestroy = function() {\n    if (chart) {\n        chart.off('datazoom');\n        chart.dispose();\n        chart = null;\n    }\n    if (zoomDebounceTimer) {\n        clearTimeout(zoomDebounceTimer);\n    }\n};\n\nself.typeParameters = function() {\n    return {\n        previewWidth: '80%',\n        embedTitlePanel: true,\n        dataKeySettingsFunction: function() { return {}; },\n        defaultDataKeysFunction: function() {\n            return [{ name: 'temperature', label: 'Temperature', type: 'timeseries', units: '', decimals: 1 }];\n        }\n    };\n};\n",
    "settingsSchema": {
      "schema": {
        "type": "object",
        "title": "Synced Zoom Time Series Settings",
        "properties": {
          "enableZoomSync": {
            "title": "Enable Zoom Sync",
            "type": "boolean",
            "default": true
          },
          "zoomSyncDebounce": {
            "title": "Zoom Sync Debounce (ms)",
            "type": "number",
            "default": 150,
            "minimum": 50,
            "maximum": 500
          },
          "showDataZoomSlider": {
            "title": "Show Zoom Slider",
            "type": "boolean",
            "default": true
          },
          "chartType": {
            "title": "Chart Type",
            "type": "string",
            "default": "line",
            "enum": ["line", "bar", "area"]
          },
          "smoothLine": {
            "title": "Smooth Lines",
            "type": "boolean",
            "default": true
          },
          "showLegend": {
            "title": "Show Legend",
            "type": "boolean",
            "default": true
          },
          "showTooltip": {
            "title": "Show Tooltip",
            "type": "boolean",
            "default": true
          },
          "stack": {
            "title": "Stack Series",
            "type": "boolean",
            "default": false
          }
        },
        "required": []
      },
      "form": [
        "enableZoomSync",
        {
          "key": "zoomSyncDebounce",
          "condition": "model.enableZoomSync === true"
        },
        "showDataZoomSlider",
        {
          "key": "chartType",
          "type": "rc-select",
          "multiple": false,
          "items": [
            { "value": "line", "label": "Line Chart" },
            { "value": "bar", "label": "Bar Chart" },
            { "value": "area", "label": "Area Chart" }
          ]
        },
        {
          "key": "smoothLine",
          "condition": "model.chartType !== 'bar'"
        },
        "showLegend",
        "showTooltip",
        "stack"
      ]
    },
    "dataKeySettingsSchema": {},
    "latestDataKeySettingsSchema": {},
    "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Value 1\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.456,\"funcBody\":\"var value = prevValue + Math.random() * 10 - 5;\\nif (value < 0) value = 0;\\nif (value > 100) value = 100;\\nreturn value;\",\"units\":\"\",\"decimals\":1},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Value 2\",\"color\":\"#4CAF50\",\"settings\":{},\"_hash\":0.789,\"funcBody\":\"var value = prevValue + Math.random() * 8 - 4;\\nif (value < 0) value = 0;\\nif (value > 80) value = 80;\\nreturn value;\",\"units\":\"\",\"decimals\":1}]}],\"timewindow\":{\"hideInterval\":false,\"hideLastInterval\":false,\"hideQuickInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":0,\"realtime\":{\"realtimeType\":0,\"timewindowMs\":3600000,\"quickInterval\":\"CURRENT_HOUR\",\"interval\":5000},\"aggregation\":{\"type\":\"AVG\",\"limit\":25000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"enableZoomSync\":true,\"zoomSyncDebounce\":150,\"showDataZoomSlider\":true,\"chartType\":\"line\",\"smoothLine\":true,\"showLegend\":true,\"showTooltip\":true,\"stack\":false},\"title\":\"Synced Zoom Time Series\",\"dropShadow\":true,\"enableFullscreen\":true,\"useDashboardTimewindow\":true,\"displayTimewindow\":true}"
  },
  "tags": [
    "chart",
    "timeseries",
    "time-series",
    "synced",
    "synchronized",
    "zoom",
    "line",
    "line chart",
    "bar",
    "bar chart",
    "area",
    "echarts"
  ]
}
