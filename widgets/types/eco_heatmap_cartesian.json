{
  "fqn": "eco_custom_widgets.eco_heatmap_cartesian",
  "name": "Heatmap Cartesian",
  "deprecated": false,
  "image": "tb-image;/api/images/system/chart.svg",
  "description": "Cartesian heatmap displaying values on an X-Y grid. Perfect for visualizing patterns across time periods (hours/days) or comparing multiple entities.",
  "descriptor": {
    "type": "timeseries",
    "sizeX": 10,
    "sizeY": 6,
    "resources": [
      {
        "url": "https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"
      }
    ],
    "templateHtml": "<div id=\"chart-container\" style=\"width: 100%; height: 100%;\"></div>",
    "templateCss": "#chart-container { position: relative; }",
    "controllerScript": "var chart = null;\nvar chartContainer = null;\nvar zoomDebounceTimer = null;\nvar isExternalUpdate = false;\n\nself.onInit = function() {\n    chartContainer = self.ctx.$container.find('#chart-container')[0];\n    if (!chartContainer) {\n        console.error('Chart container not found');\n        return;\n    }\n    \n    if (typeof echarts === 'undefined') {\n        console.error('ECharts not loaded');\n        return;\n    }\n    \n    chart = echarts.init(chartContainer);\n    \n    var settings = self.ctx.settings || {};\n    if (settings.enableZoomSync !== false) {\n        chart.on('datazoom', handleZoomSync);\n    }\n    \n    updateChart();\n};\n\nfunction handleZoomSync(params) {\n    if (isExternalUpdate) return;\n    \n    var settings = self.ctx.settings || {};\n    if (settings.enableZoomSync === false) return;\n    \n    var debounceMs = settings.zoomSyncDebounce || 150;\n    \n    if (zoomDebounceTimer) {\n        clearTimeout(zoomDebounceTimer);\n    }\n    \n    zoomDebounceTimer = setTimeout(function() {\n        var option = chart.getOption();\n        var dataZoom = option.dataZoom && option.dataZoom[0];\n        if (!dataZoom) return;\n        \n        var timeWindow = self.ctx.timeWindow;\n        if (!timeWindow) return;\n        \n        var totalRange = timeWindow.maxTime - timeWindow.minTime;\n        var startPercent = dataZoom.start || 0;\n        var endPercent = dataZoom.end || 100;\n        \n        if (startPercent > 0.5 || endPercent < 99.5) {\n            var startTime = Math.round(timeWindow.minTime + (totalRange * startPercent / 100));\n            var endTime = Math.round(timeWindow.minTime + (totalRange * endPercent / 100));\n            \n            if (self.ctx.dashboard && self.ctx.dashboard.onUpdateTimewindow) {\n                self.ctx.dashboard.onUpdateTimewindow(startTime, endTime);\n            }\n        }\n    }, debounceMs);\n}\n\nself.onDataUpdated = function() {\n    isExternalUpdate = true;\n    updateChart();\n    setTimeout(function() { isExternalUpdate = false; }, 100);\n};\n\nfunction getTimeGroupKey(timestamp, grouping) {\n    var d = new Date(timestamp);\n    switch (grouping) {\n        case 'hour':\n            return d.getHours() + ':00';\n        case 'dayOfWeek':\n            return ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][d.getDay()];\n        case 'day':\n            return d.getDate();\n        case 'week':\n            var startOfYear = new Date(d.getFullYear(), 0, 1);\n            return 'W' + Math.ceil(((d - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);\n        case 'month':\n            return ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][d.getMonth()];\n        default:\n            return d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();\n    }\n}\n\nfunction getColorScheme(scheme, minColor, maxColor) {\n    switch (scheme) {\n        case 'blue':\n            return ['#E3F2FD', '#2196F3', '#0D47A1'];\n        case 'green':\n            return ['#E8F5E9', '#4CAF50', '#1B5E20'];\n        case 'red':\n            return ['#FFEBEE', '#F44336', '#B71C1C'];\n        case 'temperature':\n            return ['#2196F3', '#FFEB3B', '#F44336'];\n        case 'custom':\n            return [minColor || '#E3F2FD', maxColor || '#0D47A1'];\n        default:\n            return ['#E3F2FD', '#2196F3', '#0D47A1'];\n    }\n}\n\nfunction updateChart() {\n    if (!chart) return;\n    \n    var settings = self.ctx.settings || {};\n    var xAxisMode = settings.xAxisMode || 'time';\n    var yAxisMode = settings.yAxisMode || 'entity';\n    var timeGrouping = settings.timeGrouping || 'hour';\n    var colorScheme = settings.colorScheme || 'blue';\n    var minColor = settings.minColor || '#E3F2FD';\n    var maxColor = settings.maxColor || '#0D47A1';\n    var showVisualMap = settings.showVisualMap !== false;\n    var minValue = settings.minValue;\n    var maxValue = settings.maxValue;\n    var showDataZoomSlider = settings.showDataZoomSlider !== false;\n    var showLegend = settings.showLegend !== false;\n    var showTooltip = settings.showTooltip !== false;\n    var enableExport = settings.enableExport !== false;\n    \n    var data = self.ctx.data || [];\n    if (!data.length) {\n        chart.setOption({\n            title: { text: 'No data', left: 'center', top: 'middle' }\n        });\n        return;\n    }\n    \n    var xCategories = [];\n    var yCategories = [];\n    var heatmapData = [];\n    var allValues = [];\n    var units = '';\n    \n    // Build aggregated data\n    var aggregated = {}; // { xKey: { yKey: { sum: 0, count: 0 } } }\n    \n    for (var i = 0; i < data.length; i++) {\n        var ds = data[i];\n        if (!ds.data || !ds.data.length) continue;\n        \n        var entityLabel = (ds.dataKey && ds.dataKey.label) || (ds.datasource && ds.datasource.name) || 'Series ' + (i + 1);\n        if (!units && ds.dataKey) units = ds.dataKey.units || '';\n        \n        if (yAxisMode === 'entity' && yCategories.indexOf(entityLabel) === -1) {\n            yCategories.push(entityLabel);\n        }\n        \n        ds.data.forEach(function(d) {\n            if (d[1] === null || d[1] === undefined || isNaN(d[1])) return;\n            \n            var xKey;\n            if (xAxisMode === 'time') {\n                xKey = getTimeGroupKey(d[0], timeGrouping);\n            } else {\n                xKey = new Date(d[0]).toLocaleDateString();\n            }\n            \n            var yKey = entityLabel;\n            \n            if (!aggregated[xKey]) aggregated[xKey] = {};\n            if (!aggregated[xKey][yKey]) aggregated[xKey][yKey] = { sum: 0, count: 0 };\n            \n            aggregated[xKey][yKey].sum += d[1];\n            aggregated[xKey][yKey].count++;\n        });\n    }\n    \n    // Sort x categories appropriately\n    xCategories = Object.keys(aggregated);\n    if (xAxisMode === 'time') {\n        if (timeGrouping === 'hour') {\n            xCategories.sort(function(a, b) { return parseInt(a) - parseInt(b); });\n        } else if (timeGrouping === 'dayOfWeek') {\n            var dayOrder = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];\n            xCategories.sort(function(a, b) { return dayOrder.indexOf(a) - dayOrder.indexOf(b); });\n        } else if (timeGrouping === 'month') {\n            var monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n            xCategories.sort(function(a, b) { return monthOrder.indexOf(a) - monthOrder.indexOf(b); });\n        } else {\n            xCategories.sort();\n        }\n    } else {\n        xCategories.sort();\n    }\n    \n    // Build heatmap data array\n    for (var xi = 0; xi < xCategories.length; xi++) {\n        for (var yi = 0; yi < yCategories.length; yi++) {\n            var xKey = xCategories[xi];\n            var yKey = yCategories[yi];\n            var val = null;\n            \n            if (aggregated[xKey] && aggregated[xKey][yKey]) {\n                val = aggregated[xKey][yKey].sum / aggregated[xKey][yKey].count;\n            }\n            \n            if (val !== null) {\n                heatmapData.push([xi, yi, val]);\n                allValues.push(val);\n            }\n        }\n    }\n    \n    if (heatmapData.length === 0) {\n        chart.setOption({\n            title: { text: 'No valid heatmap data', left: 'center', top: 'middle' }\n        });\n        return;\n    }\n    \n    var dataMin = minValue !== undefined && minValue !== null ? minValue : Math.min.apply(null, allValues);\n    var dataMax = maxValue !== undefined && maxValue !== null ? maxValue : Math.max.apply(null, allValues);\n    var colorRange = getColorScheme(colorScheme, minColor, maxColor);\n    \n    var option = {\n        tooltip: showTooltip ? {\n            formatter: function(params) {\n                return xCategories[params.data[0]] + ' / ' + yCategories[params.data[1]] + '<br/>' +\n                    'Value: ' + params.data[2].toFixed(2) + ' ' + units;\n            }\n        } : {},\n        toolbox: enableExport ? {\n            feature: {\n                saveAsImage: { title: 'Save as PNG' },\n                dataView: { title: 'Data View', readOnly: true }\n            },\n            right: 10\n        } : {},\n        grid: {\n            left: 80,\n            right: showVisualMap ? 100 : (enableExport ? 80 : 20),\n            top: 20,\n            bottom: showDataZoomSlider ? 60 : 40\n        },\n        xAxis: {\n            type: 'category',\n            data: xCategories,\n            axisLabel: { fontSize: 9, rotate: xCategories.length > 12 ? 45 : 0 },\n            splitArea: { show: true }\n        },\n        yAxis: {\n            type: 'category',\n            data: yCategories,\n            axisLabel: { fontSize: 10 },\n            splitArea: { show: true }\n        },\n        visualMap: showVisualMap ? {\n            min: dataMin,\n            max: dataMax,\n            calculable: true,\n            orient: 'vertical',\n            right: 10,\n            top: 'center',\n            inRange: {\n                color: colorRange\n            },\n            text: [units ? 'High (' + units + ')' : 'High', 'Low'],\n            textStyle: { fontSize: 10 }\n        } : {\n            show: false,\n            min: dataMin,\n            max: dataMax,\n            inRange: { color: colorRange }\n        },\n        dataZoom: [\n            { type: 'inside', xAxisIndex: 0 },\n            showDataZoomSlider ? { type: 'slider', xAxisIndex: 0, bottom: 5, height: 20 } : null\n        ].filter(function(x) { return x !== null; }),\n        series: [{\n            name: 'Heatmap',\n            type: 'heatmap',\n            data: heatmapData,\n            label: {\n                show: heatmapData.length <= 100,\n                fontSize: 9,\n                formatter: function(params) {\n                    return params.data[2].toFixed(1);\n                }\n            },\n            emphasis: {\n                itemStyle: {\n                    shadowBlur: 10,\n                    shadowColor: 'rgba(0, 0, 0, 0.5)'\n                }\n            }\n        }]\n    };\n    \n    chart.setOption(option, true);\n}\n\nself.onResize = function() {\n    if (chart) {\n        chart.resize();\n    }\n};\n\nself.onDestroy = function() {\n    if (chart) {\n        chart.off('datazoom');\n        chart.dispose();\n        chart = null;\n    }\n    if (zoomDebounceTimer) {\n        clearTimeout(zoomDebounceTimer);\n    }\n};\n\nself.typeParameters = function() {\n    return {\n        previewWidth: '80%',\n        embedTitlePanel: true,\n        dataKeySettingsFunction: function() { return {}; },\n        defaultDataKeysFunction: function() {\n            return [{ name: 'value', label: 'Value', type: 'timeseries' }];\n        }\n    };\n};\n",
    "settingsSchema": {
      "schema": {
        "type": "object",
        "title": "Heatmap Cartesian Settings",
        "properties": {
          "enableZoomSync": {
            "title": "Enable Zoom Sync",
            "type": "boolean",
            "default": true
          },
          "zoomSyncDebounce": {
            "title": "Zoom Sync Debounce (ms)",
            "type": "number",
            "default": 150,
            "minimum": 50,
            "maximum": 500
          },
          "showDataZoomSlider": {
            "title": "Show Zoom Slider",
            "type": "boolean",
            "default": true
          },
          "xAxisMode": {
            "title": "X-Axis Mode",
            "type": "string",
            "default": "time",
            "enum": ["time", "category"]
          },
          "yAxisMode": {
            "title": "Y-Axis Mode",
            "type": "string",
            "default": "entity",
            "enum": ["entity", "key"]
          },
          "timeGrouping": {
            "title": "Time Grouping",
            "type": "string",
            "default": "hour",
            "enum": ["hour", "dayOfWeek", "day", "week", "month"]
          },
          "colorScheme": {
            "title": "Color Scheme",
            "type": "string",
            "default": "blue",
            "enum": ["blue", "green", "red", "temperature", "custom"]
          },
          "minColor": {
            "title": "Min Color (custom)",
            "type": "string",
            "default": "#E3F2FD"
          },
          "maxColor": {
            "title": "Max Color (custom)",
            "type": "string",
            "default": "#0D47A1"
          },
          "showVisualMap": {
            "title": "Show Visual Map Legend",
            "type": "boolean",
            "default": true
          },
          "minValue": {
            "title": "Min Value (manual)",
            "type": "number"
          },
          "maxValue": {
            "title": "Max Value (manual)",
            "type": "number"
          },
          "showTooltip": {
            "title": "Show Tooltip",
            "type": "boolean",
            "default": true
          },
          "enableExport": {
            "title": "Enable Export (PNG/Data)",
            "type": "boolean",
            "default": true
          }
        },
        "required": []
      },
      "form": [
        "enableZoomSync",
        {
          "key": "zoomSyncDebounce",
          "condition": "model.enableZoomSync === true"
        },
        "showDataZoomSlider",
        {
          "key": "xAxisMode",
          "type": "rc-select",
          "multiple": false,
          "items": [
            { "value": "time", "label": "Time-based" },
            { "value": "category", "label": "Date categories" }
          ]
        },
        {
          "key": "yAxisMode",
          "type": "rc-select",
          "multiple": false,
          "items": [
            { "value": "entity", "label": "Entity/Series name" },
            { "value": "key", "label": "Data key name" }
          ]
        },
        {
          "key": "timeGrouping",
          "type": "rc-select",
          "multiple": false,
          "condition": "model.xAxisMode === 'time'",
          "items": [
            { "value": "hour", "label": "Hour of day (0-23)" },
            { "value": "dayOfWeek", "label": "Day of week" },
            { "value": "day", "label": "Day of month" },
            { "value": "week", "label": "Week number" },
            { "value": "month", "label": "Month" }
          ]
        },
        {
          "key": "colorScheme",
          "type": "rc-select",
          "multiple": false,
          "items": [
            { "value": "blue", "label": "Blue gradient" },
            { "value": "green", "label": "Green gradient" },
            { "value": "red", "label": "Red gradient" },
            { "value": "temperature", "label": "Temperature (blue-yellow-red)" },
            { "value": "custom", "label": "Custom colors" }
          ]
        },
        {
          "key": "minColor",
          "type": "color",
          "condition": "model.colorScheme === 'custom'"
        },
        {
          "key": "maxColor",
          "type": "color",
          "condition": "model.colorScheme === 'custom'"
        },
        "showVisualMap",
        "minValue",
        "maxValue",
        "showTooltip",
        "enableExport"
      ]
    },
    "dataKeySettingsSchema": {},
    "latestDataKeySettingsSchema": {},
    "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sensor A\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.1,\"funcBody\":\"var hour = new Date(time).getHours();\\nvar base = Math.sin(hour / 24 * Math.PI * 2) * 10 + 20;\\nreturn base + Math.random() * 5;\",\"units\":\"°C\",\"decimals\":1},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sensor B\",\"color\":\"#4CAF50\",\"settings\":{},\"_hash\":0.2,\"funcBody\":\"var hour = new Date(time).getHours();\\nvar base = Math.sin(hour / 24 * Math.PI * 2 + 1) * 8 + 22;\\nreturn base + Math.random() * 4;\",\"units\":\"°C\",\"decimals\":1},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sensor C\",\"color\":\"#FF9800\",\"settings\":{},\"_hash\":0.3,\"funcBody\":\"var hour = new Date(time).getHours();\\nvar base = Math.sin(hour / 24 * Math.PI * 2 + 2) * 12 + 18;\\nreturn base + Math.random() * 6;\",\"units\":\"°C\",\"decimals\":1}]}],\"timewindow\":{\"hideInterval\":false,\"hideLastInterval\":false,\"hideQuickInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":0,\"realtime\":{\"realtimeType\":0,\"timewindowMs\":86400000,\"quickInterval\":\"CURRENT_DAY\",\"interval\":3600000},\"aggregation\":{\"type\":\"AVG\",\"limit\":25000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"enableZoomSync\":true,\"zoomSyncDebounce\":150,\"showDataZoomSlider\":true,\"xAxisMode\":\"time\",\"yAxisMode\":\"entity\",\"timeGrouping\":\"hour\",\"colorScheme\":\"blue\",\"showVisualMap\":true,\"showTooltip\":true,\"enableExport\":true},\"title\":\"Heatmap Cartesian\",\"dropShadow\":true,\"enableFullscreen\":true,\"useDashboardTimewindow\":true,\"displayTimewindow\":true}"
  },
  "tags": [
    "chart",
    "timeseries",
    "heatmap",
    "cartesian",
    "grid",
    "matrix",
    "color",
    "echarts"
  ]
}
