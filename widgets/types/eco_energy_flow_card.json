{
  "fqn": "eco_custom_widgets.eco_energy_flow_card",
  "name": "Energy Flow Card",
  "deprecated": false,
  "image": "tb-image;/api/images/system/chart.svg",
  "description": "Animated energy flow card inspired by Home Assistant. Visualizes HVAC energy distribution with animated dot flows between circular nodes using MeasurementHierarchy relations. Groups measured (ultrasonic/import) and unmeasured (interpolated) datasources at each level. Supports power (kW avg) and energy (kWh delta) modes.",
  "descriptor": {
    "type": "timeseries",
    "sizeX": 12,
    "sizeY": 8,
    "resources": [
      {
        "url": "https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"
      }
    ],
    "templateHtml": "<div id=\"widget-wrapper\" style=\"width:100%;height:100%;display:flex;flex-direction:column;overflow:hidden;\">\n  <div id=\"timewindow-selector\" style=\"flex-shrink:0;\"></div>\n  <div id=\"toolbar\" style=\"display:flex;align-items:center;gap:8px;padding:4px 8px;border-bottom:1px solid #e0e0e0;flex-shrink:0;\">\n    <button class=\"efc-btn\" id=\"btn-refresh\" title=\"Refresh\">&#8635;</button>\n    <div id=\"mode-toggle\" style=\"display:flex;border:1px solid #ddd;border-radius:4px;overflow:hidden;\">\n      <button class=\"efc-btn efc-mode-btn active\" id=\"btn-power\">Power</button>\n      <button class=\"efc-btn efc-mode-btn\" id=\"btn-energy\">Energy</button>\n    </div>\n    <span style=\"flex:1;\"></span>\n    <span id=\"current-entity\" style=\"font-size:12px;color:#666;\"></span>\n  </div>\n  <div id=\"flow-container\" style=\"flex:1;min-height:0;position:relative;\">\n    <svg id=\"flow-svg\" style=\"position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:visible;z-index:1;\"></svg>\n    <div id=\"chart-container\" style=\"position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;\"></div>\n  </div>\n</div>",
    "templateCss": "#widget-wrapper{font-family:Roboto,sans-serif;background:#fff}\n#toolbar{background:#fafafa}\n#flow-container{background:#fff}\n#chart-container{background:transparent}\n.efc-btn{padding:4px 8px;border:1px solid #ddd;border-radius:4px;background:#fff;cursor:pointer;font-size:12px;line-height:1}\n.efc-btn:hover{background:#f0f0f0}\n.efc-mode-btn{border:none;border-radius:0;padding:4px 10px;font-size:11px;font-weight:500;transition:all .2s}\n.efc-mode-btn.active{background:#1976d2;color:#fff}\n.efc-mode-btn:not(.active){background:#f5f5f5;color:#555}\n.efc-mode-btn:not(.active):hover{background:#e0e0e0}\n@keyframes efc-flow{0%{offset-distance:0%;opacity:0}10%{opacity:1}90%{opacity:1}100%{offset-distance:100%;opacity:0}}\n.efc-dot{offset-rotate:0deg;animation:efc-flow var(--flow-duration,3s) linear infinite}\n@media(max-width:600px){.efc-mode-btn{font-size:10px;padding:3px 6px}#current-entity{display:none}}",
    "controllerScript": "var chart=null,chartContainer=null,flowSvg=null,resizeObserver=null;\nvar hierarchyTree=null,currentEntityId=null,isLoading=false,currentMode='power',nodePositions={},lastTwStart=0,lastTwEnd=0;\nvar timewindowContainer=null,entityAttributes={};\nvar COLORS={};\nvar ROLE_ICONS={generator:'bolt',subDistribution:'device_hub',circuit:'thermostat',unmeasured:'calculate'};\nvar iconSvgCache={};\nvar parsedCardTemplate=null,extraTemplateAttrs=null;\n\nvar twState={mode:'month',currentDate:new Date(),customStart:null,customEnd:null};\n\nvar userLanguage='en';\nvar translations={\n  en:{selectPeriod:'Select Period',from:'From',to:'To',cancel:'Cancel',apply:'Apply',day:'Day',week:'Week',month:'Month',custom:'Custom'},\n  de:{selectPeriod:'Zeitraum wählen',from:'Von',to:'Bis',cancel:'Abbrechen',apply:'Anwenden',day:'Tag',week:'Woche',month:'Monat',custom:'Custom'}\n};\n\nfunction t(key){var lang=userLanguage||'en';var ls=translations[lang]||translations.en;return ls[key]||translations.en[key]||key;}\n\nvar formatUtils={\n  date:function(date,format){\n    var monthsShort={en:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],de:['Jan','Feb','Mär','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez']};\n    var monthsFull={en:['January','February','March','April','May','June','July','August','September','October','November','December'],de:['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember']};\n    var d=new Date(date);var lang=userLanguage||'en';\n    var shortM=monthsShort[lang]||monthsShort.en;var fullM=monthsFull[lang]||monthsFull.en;\n    format=format||'D MMM YYYY';\n    var tokens={'YYYY':d.getFullYear(),'YY':String(d.getFullYear()).slice(-2),'MMMM':fullM[d.getMonth()],'MMM':shortM[d.getMonth()],'MM':String(d.getMonth()+1).padStart(2,'0'),'DD':String(d.getDate()).padStart(2,'0'),'D':String(d.getDate()),'M':String(d.getMonth()+1)};\n    return format.replace(/(YYYY|MMMM|MMM|MM|DD|YY|D|M)/g,function(m){return tokens[m]!==undefined?tokens[m]:m;});\n  }\n};\n\nfunction getColors(){var s=self.ctx.settings||{};COLORS={heating:s.heatingColor||'#f44336',cooling:s.coolingColor||'#2196f3',unmeasured:s.unmeasuredColor||'#9e9e9e',generator:s.generatorColor||'#4caf50'};}\n\nasync function findRelationsFrom(ers,eid,rt){var all=await ers.findByFrom(eid).toPromise();return(all||[]).filter(function(r){return r.type===rt;});}\nasync function findRelationsTo(ers,eid,rt){var all=await ers.findByTo(eid).toPromise();return(all||[]).filter(function(r){return r.type===rt;});}\n\nself.onInit=function(){\n  chartContainer=self.ctx.$container.find('#chart-container')[0];\n  flowSvg=self.ctx.$container.find('#flow-svg')[0];\n  timewindowContainer=self.ctx.$container.find('#timewindow-selector')[0];\n  if(!chartContainer){console.error('[EFC] No container');return;}\n  if(typeof echarts==='undefined'){console.error('[EFC] No ECharts');return;}\n  getColors();\n  var s=self.ctx.settings||{};\n  currentMode=s.defaultMode||'power';\n  chart=echarts.init(chartContainer);\n  setupToolbar();\n  updateModeUI();\n  // Detect language\n  try{var locale=self.ctx.$scope.$injector.get('translate').currentLang;if(locale)userLanguage=locale.substring(0,2);}catch(e){}\n  // Fetch entity attributes for timewindow selector, then init\n  fetchEntityAttributes(function(){\n    initTimewindowSelector();\n    renderTimewindowSelector();\n    applyTimewindow();\n  });\n  [100,250,500,1000].forEach(function(d){setTimeout(function(){if(chart&&chartContainer)chart.resize({width:chartContainer.offsetWidth,height:chartContainer.offsetHeight});},d);});\n  if(typeof ResizeObserver!=='undefined'){\n    resizeObserver=new ResizeObserver(function(){requestAnimationFrame(function(){if(chart&&chartContainer){chart.resize({width:chartContainer.offsetWidth,height:chartContainer.offsetHeight});if(hierarchyTree)renderNodes(hierarchyTree);}});});\n    resizeObserver.observe(chartContainer);\n  }\n};\n\nfunction setupToolbar(){\n  var toolbar=self.ctx.$container.find('#toolbar')[0];\n  var s=self.ctx.settings||{};\n  if(s.showToolbar===false){toolbar.style.display='none';return;}\n  var btnR=toolbar.querySelector('#btn-refresh');\n  if(btnR)btnR.onclick=function(){isLoading=false;loadHierarchy();};\n  var btnP=toolbar.querySelector('#btn-power');\n  var btnE=toolbar.querySelector('#btn-energy');\n  if(btnP)btnP.onclick=function(){switchMode('power');};\n  if(btnE)btnE.onclick=function(){switchMode('energy');};\n}\n\nfunction switchMode(m){if(m===currentMode)return;currentMode=m;updateModeUI();isLoading=false;loadHierarchy();}\n\nfunction updateModeUI(){\n  var btnP=self.ctx.$container.find('#btn-power')[0];\n  var btnE=self.ctx.$container.find('#btn-energy')[0];\n  if(btnP)btnP.classList.toggle('active',currentMode==='power');\n  if(btnE)btnE.classList.toggle('active',currentMode==='energy');\n}\n\n// ========== Timewindow Selector (inline) ==========\n\nfunction fetchEntityAttributes(callback){\n  var settings=self.ctx.settings||{};\n  var attrsToFetch=[];\n  [settings.twCustomStartTime,settings.twCustomEndTime].forEach(function(val){\n    if(val&&typeof val==='string'){var m=val.match(/^\\$\\{(.+)\\}$/);if(m&&attrsToFetch.indexOf(m[1])===-1)attrsToFetch.push(m[1]);}\n  });\n  if(attrsToFetch.length===0){callback();return;}\n  if(!self.ctx.datasources||self.ctx.datasources.length===0){callback();return;}\n  var ds=self.ctx.datasources[0];\n  if(!ds.entity||!ds.entity.id){callback();return;}\n  var eid=ds.entity.id.id,etype=ds.entity.id.entityType,keys=attrsToFetch.join(',');\n  var loaded=0;\n  function done(){loaded++;if(loaded>=2)callback();}\n  if(self.ctx.http){\n    self.ctx.http.get('/api/plugins/telemetry/'+etype+'/'+eid+'/values/attributes/SERVER_SCOPE?keys='+keys).subscribe(\n      function(r){if(r&&Array.isArray(r))r.forEach(function(a){entityAttributes[a.key]=a.value;});done();},\n      function(){done();}\n    );\n    self.ctx.http.get('/api/plugins/telemetry/'+etype+'/'+eid+'/values/attributes/CLIENT_SCOPE?keys='+keys).subscribe(\n      function(r){if(r&&Array.isArray(r))r.forEach(function(a){if(entityAttributes[a.key]===undefined)entityAttributes[a.key]=a.value;});done();},\n      function(){done();}\n    );\n  }else{callback();}\n}\n\nfunction initTimewindowSelector(){\n  var settings=self.ctx.settings||{};\n  if(settings.showTimewindowSelector===false){if(timewindowContainer)timewindowContainer.style.display='none';return;}\n  twState.mode=settings.twSelectorDefaultMode||'month';\n  twState.currentDate=new Date();\n  if(twState.mode==='custom'){\n    if(settings.twCustomStartTime){\n      var startMs=resolveTimeValue(settings.twCustomStartTime);\n      var endMs=settings.twCustomEndTime?resolveTimeValue(settings.twCustomEndTime):Date.now();\n      if(startMs&&startMs>0){twState.customStart=startMs;twState.customEnd=(endMs&&endMs>0)?endMs:Date.now();}\n      else{var today=new Date();today.setHours(0,0,0,0);twState.customStart=today.getTime();twState.customEnd=Date.now();}\n    }else{\n      var tw=self.ctx.timeWindow;\n      if(tw&&tw.fixedTimewindow&&tw.fixedTimewindow.startTimeMs){twState.customStart=tw.fixedTimewindow.startTimeMs;twState.customEnd=tw.fixedTimewindow.endTimeMs||Date.now();}\n      else if(tw&&tw.history&&tw.history.fixedTimewindow){twState.customStart=tw.history.fixedTimewindow.startTimeMs;twState.customEnd=tw.history.fixedTimewindow.endTimeMs||Date.now();}\n      else{var td=new Date();td.setHours(0,0,0,0);twState.customStart=td.getTime();twState.customEnd=Date.now();}\n    }\n  }\n}\n\nfunction resolveTimeValue(valueStr){\n  if(!valueStr||valueStr==='')return null;\n  var varMatch=valueStr.match(/^\\$\\{(.+)\\}$/);\n  if(varMatch){\n    var attrName=varMatch[1];\n    if(entityAttributes[attrName]!==undefined){var v=Number(entityAttributes[attrName]);if(!isNaN(v)&&v>0)return v;}\n    if(self.ctx.latestData){\n      for(var i=0;i<self.ctx.latestData.length;i++){\n        var ld=self.ctx.latestData[i];\n        if(ld.dataKey&&ld.dataKey.name===attrName&&ld.data&&ld.data.length>0){var v2=Number(ld.data[ld.data.length-1][1]);if(!isNaN(v2)&&v2>0)return v2;}\n      }\n    }\n    return null;\n  }\n  var numVal=Number(valueStr);\n  if(!isNaN(numVal)&&numVal>0)return numVal;\n  var dateVal=Date.parse(valueStr);\n  if(!isNaN(dateVal))return dateVal;\n  return null;\n}\n\nfunction renderTimewindowSelector(){\n  if(!timewindowContainer)return;\n  var settings=self.ctx.settings||{};\n  if(settings.showTimewindowSelector===false){timewindowContainer.style.display='none';return;}\n  while(timewindowContainer.firstChild)timewindowContainer.removeChild(timewindowContainer.firstChild);\n  var accentColor=settings.twSelectorColor||'#2196F3';\n  if(!settings.twSelectorColor&&self.ctx.data&&self.ctx.data[0]&&self.ctx.data[0].dataKey){accentColor=self.ctx.data[0].dataKey.color||'#2196F3';}\n  var posMap={left:'flex-start',center:'center',right:'flex-end'};\n  timewindowContainer.style.display='flex';\n  timewindowContainer.style.alignItems='center';\n  timewindowContainer.style.justifyContent=posMap[settings.twSelectorPosition||'center']||'center';\n  timewindowContainer.style.padding='8px';\n  var wrapper=document.createElement('div');\n  wrapper.style.cssText='display:flex;align-items:center;gap:6px;background:'+accentColor+';border-radius:6px;padding:6px 10px;box-shadow:0 2px 6px rgba(0,0,0,0.12);';\n  if(twState.mode!=='custom'){var navL=createTwButton('\\u25C0',function(){twNavigate(-1);});wrapper.appendChild(navL);}\n  var btnC=document.createElement('div');btnC.style.cssText='display:flex;gap:4px;';\n  [{id:'day',label:'D'},{id:'week',label:'W'},{id:'month',label:'M'},{id:'custom',label:'C'}].forEach(function(m){\n    var isA=twState.mode===m.id;\n    var btn=document.createElement('button');btn.textContent=m.label;btn.title=t(m.id);\n    btn.style.cssText='border:none;width:28px;height:24px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;transition:all 0.2s;';\n    if(isA){btn.style.background='white';btn.style.color=accentColor;}\n    else{btn.style.background='rgba(255,255,255,0.2)';btn.style.color='white';}\n    btn.onmouseover=function(){if(!isA)btn.style.background='rgba(255,255,255,0.35)';};\n    btn.onmouseout=function(){if(!isA)btn.style.background='rgba(255,255,255,0.2)';};\n    btn.onclick=function(){twSelectMode(m.id);};\n    btnC.appendChild(btn);\n  });\n  wrapper.appendChild(btnC);\n  if(twState.mode!=='custom'){var navR=createTwButton('\\u25B6',function(){twNavigate(1);});wrapper.appendChild(navR);}\n  var label=document.createElement('span');\n  label.style.cssText='color:white;font-size:11px;margin-left:8px;opacity:0.9;';\n  label.textContent=twFormatLabel();\n  wrapper.appendChild(label);\n  if(twState.mode==='custom'){\n    var calBtn=createTwButton('\\uD83D\\uDCC5',function(e){e.stopPropagation();showDatePicker(wrapper,accentColor);});\n    calBtn.style.marginLeft='4px';wrapper.appendChild(calBtn);\n  }\n  timewindowContainer.appendChild(wrapper);\n}\n\nfunction createTwButton(text,onClick){\n  var btn=document.createElement('button');btn.textContent=text;\n  btn.style.cssText='background:rgba(255,255,255,0.2);border:none;color:white;width:24px;height:24px;border-radius:4px;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;transition:background 0.2s;';\n  btn.onmouseover=function(){btn.style.background='rgba(255,255,255,0.35)';};\n  btn.onmouseout=function(){btn.style.background='rgba(255,255,255,0.2)';};\n  btn.onclick=onClick;return btn;\n}\n\nfunction twSelectMode(mode){\n  twState.mode=mode;\n  if(mode!=='custom'){twState.currentDate=new Date();twState.customStart=null;twState.customEnd=null;}\n  applyTimewindow();\n  renderTimewindowSelector();\n}\n\nfunction twNavigate(dir){\n  var d=new Date(twState.currentDate);\n  switch(twState.mode){\n    case 'day':d.setDate(d.getDate()+dir);break;\n    case 'week':d.setDate(d.getDate()+(dir*7));break;\n    case 'month':d.setMonth(d.getMonth()+dir);break;\n  }\n  twState.currentDate=d;\n  applyTimewindow();\n  renderTimewindowSelector();\n}\n\nfunction twCalculateRange(){\n  var settings=self.ctx.settings||{};\n  var d=new Date(twState.currentDate);\n  var start,end;\n  switch(twState.mode){\n    case 'day':\n      start=new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0);\n      end=new Date(d.getFullYear(),d.getMonth(),d.getDate(),23,59,59,999);\n      break;\n    case 'week':\n      var dow=d.getDay(),diff=(dow===0?-6:1)-dow;\n      var mon=new Date(d);mon.setDate(d.getDate()+diff);\n      start=new Date(mon.getFullYear(),mon.getMonth(),mon.getDate(),0,0,0,0);\n      var sun=new Date(mon);sun.setDate(mon.getDate()+6);\n      end=new Date(sun.getFullYear(),sun.getMonth(),sun.getDate(),23,59,59,999);\n      break;\n    case 'month':\n      start=new Date(d.getFullYear(),d.getMonth(),1,0,0,0,0);\n      end=new Date(d.getFullYear(),d.getMonth()+1,0,23,59,59,999);\n      break;\n    case 'custom':\n      if(twState.customStart&&twState.customEnd)return{start:twState.customStart,end:twState.customEnd};\n      if(settings.twCustomStartTime){var s=resolveTimeValue(settings.twCustomStartTime);var e=settings.twCustomEndTime?resolveTimeValue(settings.twCustomEndTime):Date.now();if(s)return{start:s,end:e||Date.now()};}\n      var td=new Date();td.setHours(0,0,0,0);return{start:td.getTime(),end:Date.now()};\n  }\n  return{start:start.getTime(),end:end.getTime()};\n}\n\nfunction applyTimewindow(){\n  var range=twCalculateRange();\n  if(!range)return;\n  lastTwStart=range.start;lastTwEnd=range.end;\n  reloadValues();\n  if(self.ctx.timewindowFunctions&&self.ctx.timewindowFunctions.onUpdateTimewindow){\n    if(self.ctx.$scope&&self.ctx.$scope.$$postDigest){\n      self.ctx.$scope.$$postDigest(function(){self.ctx.timewindowFunctions.onUpdateTimewindow(range.start,range.end);});\n    }else{\n      setTimeout(function(){self.ctx.timewindowFunctions.onUpdateTimewindow(range.start,range.end);},0);\n    }\n  }\n}\n\nfunction twFormatLabel(){\n  var settings=self.ctx.settings||{};\n  var d=twState.currentDate;\n  switch(twState.mode){\n    case 'day':return formatUtils.date(d,settings.twSelectorDayFormat||'DD.MM.YYYY');\n    case 'week':\n      var range=twCalculateRange();\n      if(range){\n        var sD=new Date(range.start),eD=new Date(range.end);\n        var fmt=settings.twSelectorWeekFormat||'DD.MM.YYYY - DD.MM.YYYY';\n        if(fmt.indexOf(' - ')!==-1){var parts=fmt.split(' - ');return formatUtils.date(sD,parts[0])+' - '+formatUtils.date(eD,parts[1]||parts[0]);}\n        return formatUtils.date(sD,'DD.MM.YYYY')+' - '+formatUtils.date(eD,'DD.MM.YYYY');\n      }\n      return '';\n    case 'month':return formatUtils.date(d,settings.twSelectorMonthFormat||'MMMM YYYY');\n    case 'custom':\n      if(twState.customStart&&twState.customEnd)return formatUtils.date(new Date(twState.customStart),'DD.MM.YY')+' - '+formatUtils.date(new Date(twState.customEnd),'DD.MM.YY');\n      var tw=self.ctx.timeWindow;\n      if(tw){\n        var cs,ce;\n        if(tw.fixedTimewindow){cs=tw.fixedTimewindow.startTimeMs;ce=tw.fixedTimewindow.endTimeMs;}\n        else{cs=tw.minTime||tw.startTs;ce=tw.maxTime||(tw.startTs&&tw.tsRange?tw.startTs+tw.tsRange:null);}\n        if(cs&&ce)return formatUtils.date(new Date(cs),'DD.MM.YY')+' - '+formatUtils.date(new Date(ce),'DD.MM.YY');\n      }\n      return 'Dashboard';\n  }\n  return '';\n}\n\nfunction showDatePicker(anchor,accentColor){\n  var existing=document.getElementById('eco-tw-datepicker');\n  if(existing){existing.remove();return;}\n  var startDate=new Date(),endDate=new Date();\n  startDate.setDate(startDate.getDate()-7);\n  if(twState.customStart&&twState.customEnd){startDate=new Date(twState.customStart);endDate=new Date(twState.customEnd);}\n  function toInp(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}\n  var picker=document.createElement('div');picker.id='eco-tw-datepicker';\n  picker.style.cssText='position:absolute;top:100%;left:50%;transform:translateX(-50%);margin-top:4px;background:white;border-radius:8px;padding:12px;box-shadow:0 4px 20px rgba(0,0,0,0.25);z-index:10000;min-width:280px;';\n  var title=document.createElement('div');title.style.cssText='font-size:12px;font-weight:600;color:#333;margin-bottom:10px;';title.textContent=t('selectPeriod');picker.appendChild(title);\n  var row=document.createElement('div');row.style.cssText='display:flex;gap:8px;';\n  var sDiv=document.createElement('div');sDiv.style.cssText='flex:1;';\n  var sLbl=document.createElement('label');sLbl.style.cssText='font-size:10px;color:#666;display:block;margin-bottom:2px;';sLbl.textContent=t('from');\n  var sInp=document.createElement('input');sInp.type='date';sInp.value=toInp(startDate);sInp.style.cssText='width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:12px;box-sizing:border-box;';\n  sDiv.appendChild(sLbl);sDiv.appendChild(sInp);row.appendChild(sDiv);\n  var eDiv=document.createElement('div');eDiv.style.cssText='flex:1;';\n  var eLbl=document.createElement('label');eLbl.style.cssText='font-size:10px;color:#666;display:block;margin-bottom:2px;';eLbl.textContent=t('to');\n  var eInp=document.createElement('input');eInp.type='date';eInp.value=toInp(endDate);eInp.style.cssText='width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:12px;box-sizing:border-box;';\n  eDiv.appendChild(eLbl);eDiv.appendChild(eInp);row.appendChild(eDiv);picker.appendChild(row);\n  var btnRow=document.createElement('div');btnRow.style.cssText='display:flex;gap:6px;justify-content:flex-end;margin-top:10px;';\n  var cBtn=document.createElement('button');cBtn.textContent=t('cancel');cBtn.style.cssText='padding:6px 12px;border:1px solid #ddd;background:white;border-radius:4px;font-size:11px;cursor:pointer;';\n  cBtn.onclick=function(e){e.stopPropagation();picker.remove();};\n  var aBtn=document.createElement('button');aBtn.textContent=t('apply');aBtn.style.cssText='padding:6px 12px;border:none;background:'+accentColor+';color:white;border-radius:4px;font-size:11px;cursor:pointer;font-weight:500;';\n  aBtn.onclick=function(e){e.stopPropagation();var ns=new Date(sInp.value);var ne=new Date(eInp.value);ne.setHours(23,59,59,999);twState.customStart=ns.getTime();twState.customEnd=ne.getTime();applyTimewindow();picker.remove();renderTimewindowSelector();};\n  btnRow.appendChild(cBtn);btnRow.appendChild(aBtn);picker.appendChild(btnRow);\n  anchor.style.position='relative';anchor.appendChild(picker);\n  setTimeout(function(){document.addEventListener('click',function closeH(e){if(!picker.contains(e.target)){picker.remove();document.removeEventListener('click',closeH);}});},100);\n}\n\n// ========== Data Loading ==========\n\nself.onDataUpdated=function(){\n  var data=self.ctx.data||[];\n  if(data.length>0&&data[0].datasource&&data[0].datasource.entity){\n    var entity=data[0].datasource.entity;\n    var changed=!currentEntityId||currentEntityId.id!==entity.id.id;\n    currentEntityId=entity.id;\n    var tw=getTimewindow();\n    var twChanged=tw.start!==lastTwStart||tw.end!==lastTwEnd;\n    lastTwStart=tw.start;lastTwEnd=tw.end;\n    if(changed||!hierarchyTree){loadHierarchy();}\n    else if(twChanged){reloadValues();}\n  }\n};\n\nasync function loadHierarchy(){\n  if(isLoading)return;\n  if(!self.ctx.data||!self.ctx.data.length)return;\n  var ds=self.ctx.data[0].datasource;\n  if(!ds||!ds.entity)return;\n  isLoading=true;\n  parsedCardTemplate=null;extraTemplateAttrs=null;\n  var rootEntity=ds.entity;\n  currentEntityId=rootEntity.id;\n  var s=self.ctx.settings||{};\n  var relType=s.relationType||'MeasurementHierarchy';\n  var elLabel=self.ctx.$container.find('#current-entity')[0];\n  if(elLabel)elLabel.textContent=rootEntity.label||rootEntity.name||'';\n  chart.showLoading();\n  try{\n    var $inj=self.ctx.$scope.$injector;\n    var ers=$inj.get(self.ctx.servicesMap.get('entityRelationService'));\n    var as=$inj.get(self.ctx.servicesMap.get('attributeService'));\n    var rootId=await findRoot(rootEntity.id,ers,relType);\n    hierarchyTree=await buildTree(rootId,ers,as,relType,s,0,{});\n    if(!hierarchyTree){chart.hideLoading();showError('No hierarchy found');isLoading=false;return;}\n    await loadAllValues(hierarchyTree,s);\n    processHierarchy(hierarchyTree);\n    await preloadMdiIcons();\n    chart.hideLoading();\n    renderNodes(hierarchyTree);\n  }catch(e){console.error('[EFC] Load error:',e);chart.hideLoading();showError('Load failed: '+e.message);}\n  finally{isLoading=false;}\n}\n\nasync function preloadMdiIcons(){\n  var s=self.ctx.settings||{};\n  var icons=[s.generatorIcon,s.subDistributionIcon,s.circuitIcon,s.unmeasuredIcon];\n  var loads=[];\n  icons.forEach(function(ic){\n    if(ic&&isMdiIcon(ic)){loads.push(loadMdiSvg(ic,'#fff'));loads.push(loadMdiSvg(ic,'#999'));}\n  });\n  if(loads.length>0)await Promise.all(loads);\n}\n\nasync function reloadValues(){\n  if(isLoading||!hierarchyTree)return;\n  isLoading=true;\n  try{\n    var s=self.ctx.settings||{};\n    unprocessHierarchy(hierarchyTree);\n    await loadAllValues(hierarchyTree,s);\n    processHierarchy(hierarchyTree);\n    await preloadMdiIcons();\n    renderNodes(hierarchyTree);\n  }catch(e){console.error('[EFC] Reload error:',e);}\n  finally{isLoading=false;}\n}\n\nasync function findRoot(eid,ers,rt){\n  var cur=eid,visited={};\n  for(var i=0;i<10;i++){\n    var k=cur.entityType+':'+cur.id;\n    if(visited[k])break;visited[k]=true;\n    try{var rels=await findRelationsTo(ers,cur,rt);if(!rels||rels.length===0)break;cur=rels[0].from;}catch(e){break;}\n  }\n  return cur;\n}\n\nasync function buildTree(eid,ers,as,rt,settings,depth,visited){\n  if(depth>6)return null;\n  var k=eid.entityType+':'+eid.id;\n  if(visited[k])return null;visited[k]=true;\n  var node=await buildNode(eid,as,settings);\n  node.children=[];\n  try{\n    var rels=await findRelationsFrom(ers,eid,rt);\n    if(rels&&rels.length>0){\n      var cp=rels.map(function(r){return buildTree(r.to,ers,as,rt,settings,depth+1,visited);});\n      var ch=await Promise.all(cp);\n      node.children=ch.filter(function(c){return c!==null;});\n    }\n  }catch(e){console.warn('[EFC] Children error:',node.name,e);}\n  return node;\n}\n\nasync function buildNode(eid,as,settings){\n  var wAttr=settings&&settings.weightAttribute?settings.weightAttribute:'interpolationWeight';\n  var node={id:eid.id,entityId:eid,entityName:'',entityLabel:'',name:'',role:'circuit',installationType:'heating',measurementType:'',interpolationWeight:null,value:0,isVirtual:false,isUnmeasuredGroup:false,children:[],attributes:{}};\n  try{\n    var etLower=eid.entityType.toLowerCase();\n    var entityResp=await self.ctx.http.get('/api/'+etLower+'/'+eid.id).toPromise();\n    if(entityResp){node.entityName=entityResp.name||'';node.entityLabel=entityResp.label||'';node.name=node.entityLabel||node.entityName||'';}\n  }catch(e){}\n  try{\n    var baseKeys=['measurementRole','installationType','measurementType',wAttr];\n    var ea=getExtraTemplateAttrs();\n    var fetchKeys=baseKeys.concat(ea);\n    var attrs=await as.getEntityAttributes(eid,'SERVER_SCOPE',fetchKeys).toPromise();\n    attrs.forEach(function(a){\n      if(a.key==='measurementRole')node.role=a.value||'circuit';\n      if(a.key==='installationType')node.installationType=a.value||'heating';\n      if(a.key==='measurementType')node.measurementType=a.value||'';\n      if(a.key===wAttr&&a.value!==null&&a.value!==undefined)node.interpolationWeight=parseFloat(a.value)||null;\n      if(ea.indexOf(a.key)!==-1)node.attributes[a.key]=a.value;\n    });\n    if(!node.name)node.name=eid.id.substring(0,8);\n  }catch(e){if(!node.name)node.name=eid.id.substring(0,8);}\n  return node;\n}\n\nasync function loadAllValues(tree,s){\n  var nodes=[];collectNodesToLoad(tree,nodes);\n  await Promise.all(nodes.map(function(n){return loadNodeValue(n,s);}));\n}\n\nfunction collectNodesToLoad(node,arr){\n  if(!node.isVirtual&&node.measurementType!=='interpolated'&&node.measurementType!=='lorawan')arr.push(node);\n  if(node.children)node.children.forEach(function(c){collectNodesToLoad(c,arr);});\n}\n\nasync function loadNodeValue(node,s){\n  if(!node||!node.entityId)return;\n  var tw=getTimewindow();\n  var et=node.entityId.entityType,id=node.entityId.id;\n  try{\n    if(currentMode==='power'){\n      var pk=s.powerAttribute||'P_th_kW';\n      var interval=Math.max(1,tw.end-tw.start);\n      var url='/api/plugins/telemetry/'+et+'/'+id+'/values/timeseries?keys='+pk+'&startTs='+tw.start+'&endTs='+tw.end+'&agg=AVG&interval='+interval;\n      var resp=await self.ctx.http.get(url).toPromise();\n      if(resp&&resp[pk]&&resp[pk].length>0)node.value=parseFloat(resp[pk][0].value)||0;\n      else node.value=0;\n    }else{\n      var ek=s.energyAttribute||'E_th_kWh';\n      var base='/api/plugins/telemetry/'+et+'/'+id+'/values/timeseries?keys='+ek+'&startTs='+tw.start+'&endTs='+tw.end;\n      var res=await Promise.all([self.ctx.http.get(base+'&limit=1&orderBy=ASC&agg=NONE').toPromise(),self.ctx.http.get(base+'&limit=1&orderBy=DESC&agg=NONE').toPromise()]);\n      var fv=0,lv=0;\n      if(res[0]&&res[0][ek]&&res[0][ek].length>0)fv=parseFloat(res[0][ek][0].value)||0;\n      if(res[1]&&res[1][ek]&&res[1][ek].length>0)lv=parseFloat(res[1][ek][0].value)||0;\n      node.value=lv-fv;if(node.value<0)node.value=0;\n    }\n  }catch(e){console.warn('[EFC] Value load failed:',node.name,e);node.value=0;}\n}\n\nfunction getTimewindow(){\n  var range=twCalculateRange();\n  if(range&&range.start&&range.end)return range;\n  var tw=self.ctx.timeWindow;\n  var start,end;\n  if(tw){\n    if(tw.fixedTimewindow){start=tw.fixedTimewindow.startTimeMs;end=tw.fixedTimewindow.endTimeMs;}\n    else{start=tw.minTime||tw.startTs||(Date.now()-86400000);end=tw.maxTime||(tw.startTs+tw.tsRange)||Date.now();}\n  }else{start=Date.now()-86400000;end=Date.now();}\n  return{start:start,end:end};\n}\n\n// ========== Hierarchy Processing ==========\n\nfunction processHierarchy(node){\n  if(!node||!node.children||node.children.length===0)return;\n  node.children.forEach(function(c){processHierarchy(c);});\n  node.children=node.children.filter(function(c){return c.measurementType!=='lorawan';});\n  var measured=[],interpolated=[];\n  node.children.forEach(function(c){if(c.measurementType==='interpolated')interpolated.push(c);else measured.push(c);});\n  var measuredSum=measured.reduce(function(s,c){return s+(c.value||0);},0);\n  var unmeasuredTotal=Math.max(0,(node.value||0)-measuredSum);\n  if(interpolated.length>0){\n    var totalWeight=0;\n    interpolated.forEach(function(c){c._weight=c.interpolationWeight||1;totalWeight+=c._weight;});\n    interpolated.forEach(function(c){c.value=totalWeight>0?unmeasuredTotal*(c._weight/totalWeight):0;});\n    var grp={id:node.id+'_unmeasured',entityId:null,entityName:'',entityLabel:'',name:'Unmeasured',role:'unmeasured',installationType:node.installationType,measurementType:'',interpolationWeight:null,value:unmeasuredTotal,isVirtual:true,isUnmeasuredGroup:true,children:interpolated};\n    node.children=measured.concat([grp]);\n  }else if(unmeasuredTotal>0.1){\n    node.children=measured.concat([{id:node.id+'_unmeasured',entityId:null,entityName:'',entityLabel:'',name:'Unmeasured',role:'unmeasured',installationType:node.installationType,measurementType:'',interpolationWeight:null,value:unmeasuredTotal,isVirtual:true,isUnmeasuredGroup:false,children:[]}]);\n  }else{\n    node.children=measured;\n  }\n}\n\nfunction unprocessHierarchy(node){\n  if(!node||!node.children)return;\n  var restored=[];\n  node.children.forEach(function(c){\n    if(c.isUnmeasuredGroup&&c.children){c.children.forEach(function(ic){ic.value=0;restored.push(ic);});}\n    else if(!c.isVirtual){restored.push(c);}\n  });\n  node.children=restored;\n  node.children.forEach(function(c){unprocessHierarchy(c);});\n}\n\n// ========== Rendering ==========\n\nfunction renderNodes(tree){\n  if(!chart||!chartContainer||!tree)return;\n  var w=chartContainer.offsetWidth,h=chartContainer.offsetHeight;\n  if(w===0||h===0)return;\n  var s=self.ctx.settings||{};\n  var isCard=s.labelMode==='custom';\n  var depth=getMaxDepth(tree);\n  var pad=40;\n  if(isCard){\n    var maxCardH=calculateMaxCardHeight(tree);\n    var cardW=Math.min(160,Math.max(80,w*0.15));\n    var gap=20;\n    var lvlH=depth>0?(h-2*pad-maxCardH)/(depth):0;\n    lvlH=Math.max(lvlH,maxCardH+gap);\n    nodePositions={};\n    layoutTreeCards(tree,pad,pad+maxCardH/2,w-2*pad,lvlH,cardW,0);\n  }else{\n    var nodeR=Math.min(40,Math.max(20,Math.min(w,h)/(depth+2)/2.5));\n    var lvlH=depth>0?(h-2*pad-nodeR*2)/depth:0;\n    nodePositions={};\n    layoutTree(tree,pad,pad+nodeR,w-2*pad,lvlH,nodeR,0);\n  }\n  var elems=[];\n  collectGraphicElements(tree,elems);\n  chart.setOption({backgroundColor:'transparent',graphic:{elements:elems}},true);\n  chart.off('click');\n  chart.on('click',function(p){if(p.topTarget&&p.topTarget._nk){var pos=nodePositions[p.topTarget._nk];if(pos&&pos.node&&!pos.node.isVirtual&&pos.node.entityId)navigateToEntity(pos.node);}});\n  renderFlowPaths(tree);\n}\n\nfunction getMaxDepth(n){if(!n.children||n.children.length===0)return 0;var m=0;n.children.forEach(function(c){m=Math.max(m,getMaxDepth(c));});return m+1;}\nfunction countLeaves(n){if(!n.children||n.children.length===0)return 1;var c=0;n.children.forEach(function(ch){c+=countLeaves(ch);});return c;}\n\nfunction layoutTree(node,x,y,width,lvlH,baseR,depth){\n  var r=Math.max(16,baseR*Math.pow(0.9,depth));\n  node._x=x+width/2;node._y=y;node._r=r;node._depth=depth;node._isCard=false;\n  var key='n_'+node.id;\n  nodePositions[key]={x:node._x,y:node._y,node:node};\n  if(!node.children||node.children.length===0)return;\n  var totalL=countLeaves(node),childX=x;\n  node.children.forEach(function(ch){\n    var chL=countLeaves(ch),chW=(chL/totalL)*width;\n    layoutTree(ch,childX,y+lvlH,chW,lvlH,baseR,depth+1);\n    childX+=chW;\n  });\n}\n\nfunction calculateMaxCardHeight(tree){\n  var maxH=50;\n  function walk(n){var ch=calculateCardHeight(n);if(ch>maxH)maxH=ch;if(n.children)n.children.forEach(walk);}\n  walk(tree);\n  return maxH;\n}\n\nfunction layoutTreeCards(node,x,y,width,lvlH,cardW,depth){\n  node._w=cardW;node._h=calculateCardHeight(node);\n  node._x=x+width/2;node._y=y;node._depth=depth;node._isCard=true;\n  var key='n_'+node.id;\n  nodePositions[key]={x:node._x,y:node._y,node:node};\n  if(!node.children||node.children.length===0)return;\n  var totalL=countLeaves(node),childX=x;\n  node.children.forEach(function(ch){\n    var chL=countLeaves(ch),chW=(chL/totalL)*width;\n    layoutTreeCards(ch,childX,y+lvlH,chW,lvlH,cardW,depth+1);\n    childX+=chW;\n  });\n}\n\nfunction collectGraphicElements(node,elems){\n  var key='n_'+node.id;\n  if(node._isCard){\n    elems.push.apply(elems,createCardGraphic(node,node._x,node._y,node._w,node._h,key));\n  }else{\n    elems.push.apply(elems,createNodeGraphic(node,node._x,node._y,node._r,key));\n  }\n  if(node.children)node.children.forEach(function(c){collectGraphicElements(c,elems);});\n}\n\nfunction createNodeGraphic(node,cx,cy,r,key){\n  var s=self.ctx.settings||{};\n  var col=getNodeColor(node),icon=getNodeIcon(node,s);\n  var val=formatValue(node.value,currentMode),dash=node.isVirtual;\n  var isInterp=node.measurementType==='interpolated';\n  var els=[];\n  els.push({type:'circle',shape:{cx:cx,cy:cy,r:r},style:{fill:dash?'#f5f5f5':col,stroke:dash?COLORS.unmeasured:(isInterp?COLORS.unmeasured:col),lineWidth:dash?2:(isInterp?2:0),lineDash:dash?[4,4]:(isInterp?[2,2]:null),shadowBlur:dash?0:8,shadowColor:dash?'transparent':col+'44',opacity:dash?0.15:0.15},z:10,_nk:key});\n  els.push({type:'circle',shape:{cx:cx,cy:cy,r:r*0.88},style:{fill:dash?'#fafafa':col,stroke:isInterp?COLORS.unmeasured:'rgba(255,255,255,0.3)',lineWidth:2,lineDash:dash?[3,3]:(isInterp?[2,2]:null),opacity:isInterp?0.7:1},z:11,_nk:key});\n  var iconFill=dash?'#999':'#fff';\n  if(isMdiIcon(icon)&&iconSvgCache[getMdiName(icon)+'_'+iconFill]){\n    var iSize=Math.max(14,r*0.5);\n    els.push({type:'image',style:{image:iconSvgCache[getMdiName(icon)+'_'+iconFill],x:cx-iSize/2,y:cy-r*0.2-iSize/2,width:iSize,height:iSize},z:12,_nk:key});\n  }else{\n    var iconText=isMdiIcon(icon)?'help_outline':icon;\n    els.push({type:'text',style:{x:cx,y:cy-r*0.2,text:iconText,textAlign:'center',textVerticalAlign:'middle',fontSize:Math.max(11,r*0.4),fontFamily:'Material Icons',fill:iconFill},z:12,_nk:key});\n  }\n  els.push({type:'text',style:{x:cx,y:cy+r*0.25,text:val,textAlign:'center',textVerticalAlign:'middle',fontSize:Math.max(9,r*0.28),fontWeight:'bold',fill:dash?'#666':'#fff'},z:12,_nk:key});\n  // Entity label + name to the right\n  var labelText=node.entityLabel||node.name||'';\n  var nameText=node.entityName||'';\n  if(labelText===nameText)nameText='';\n  var labelX=cx+r+8;\n  var fs=Math.max(9,Math.min(12,r*0.32));\n  if(labelText){els.push({type:'text',style:{x:labelX,y:nameText?cy-fs*0.4:cy,text:truncName(labelText,22),textAlign:'left',textVerticalAlign:'middle',fontSize:fs,fontWeight:'600',fill:dash?'#999':'#333'},z:12,_nk:key});}\n  if(nameText){els.push({type:'text',style:{x:labelX,y:labelText?cy+fs*0.8:cy,text:truncName(nameText,22),textAlign:'left',textVerticalAlign:'middle',fontSize:Math.max(8,fs-1),fill:dash?'#bbb':'#777'},z:12,_nk:key});}\n  return els;\n}\n\nfunction getNodeColor(n){if(n.isVirtual)return COLORS.unmeasured;if(n.role==='generator')return COLORS.generator;return n.installationType==='cooling'?COLORS.cooling:COLORS.heating;}\nfunction getNodeIcon(n,s){var raw;if(n.isVirtual||n.isUnmeasuredGroup)raw=s.unmeasuredIcon||ROLE_ICONS.unmeasured;else if(n.role==='generator')raw=s.generatorIcon||ROLE_ICONS.generator;else if(n.role==='subDistribution')raw=s.subDistributionIcon||ROLE_ICONS.subDistribution;else raw=s.circuitIcon||ROLE_ICONS.circuit;return raw||'help_outline';}\nfunction isMdiIcon(name){return name&&name.indexOf('mdi:')===0;}\nfunction getMdiName(name){return name.substring(4);}\nfunction loadMdiSvg(name,color){\n  var mdiName=getMdiName(name);\n  var cacheKey=mdiName+'_'+color;\n  if(iconSvgCache[cacheKey])return Promise.resolve(iconSvgCache[cacheKey]);\n  var url='https://cdn.jsdelivr.net/npm/@mdi/svg@latest/svg/'+mdiName+'.svg';\n  return self.ctx.http.get(url,{responseType:'text'}).toPromise().then(function(svg){\n    svg=svg.replace(/<path /g,'<path fill=\"'+color+'\" ');\n    var dataUrl='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svg);\n    iconSvgCache[cacheKey]=dataUrl;\n    return dataUrl;\n  }).catch(function(){iconSvgCache[cacheKey]=null;return null;});\n}\nfunction truncName(n,mx){if(!n)return'';if(n.length<=mx)return n;return n.substring(0,mx-1)+'\\u2026';}\n\nfunction formatValue(v,mode){\n  if(v===null||v===undefined||isNaN(v))return'N/A';\n  var a=Math.abs(v);\n  if(mode==='power'){if(a>=1000)return(v/1000).toFixed(1)+' MW';if(a>=1)return v.toFixed(1)+' kW';return(v*1000).toFixed(0)+' W';}\n  else{if(a>=1000)return(v/1000).toFixed(1)+' MWh';if(a>=1)return v.toFixed(1)+' kWh';return(v*1000).toFixed(0)+' Wh';}\n}\n\n// ========== Card Template Helpers ==========\n\nvar BUILTIN_VARS={entityLabel:1,entityName:1,value:1,unit:1,measurementRole:1,installationType:1,measurementType:1};\n\nfunction getCardTemplate(){\n  if(parsedCardTemplate)return parsedCardTemplate;\n  var s=self.ctx.settings||{};\n  if(!s.cardTemplate)return null;\n  try{parsedCardTemplate=JSON.parse(s.cardTemplate);}catch(e){console.warn('[EFC] Bad cardTemplate JSON:',e);return null;}\n  return parsedCardTemplate;\n}\n\nfunction getExtraTemplateAttrs(){\n  if(extraTemplateAttrs)return extraTemplateAttrs;\n  extraTemplateAttrs=[];\n  var tpl=getCardTemplate();\n  if(!tpl)return extraTemplateAttrs;\n  var seen={};\n  tpl.forEach(function(line){\n    if(!line.text)return;\n    var rx=/\\$\\{(\\w+)\\}/g,m;\n    while((m=rx.exec(line.text))!==null){\n      if(!BUILTIN_VARS[m[1]]&&!seen[m[1]]){seen[m[1]]=true;extraTemplateAttrs.push(m[1]);}\n    }\n    if(line.condition&&!BUILTIN_VARS[line.condition]&&!seen[line.condition]){seen[line.condition]=true;extraTemplateAttrs.push(line.condition);}\n  });\n  return extraTemplateAttrs;\n}\n\nfunction resolveTemplateLine(line,node){\n  if(line.condition){\n    var condVal=node.attributes?node.attributes[line.condition]:undefined;\n    if(BUILTIN_VARS[line.condition]){\n      if(line.condition==='entityLabel')condVal=node.entityLabel||node.name;\n      else if(line.condition==='entityName')condVal=node.entityName;\n      else if(line.condition==='value')condVal=node.value;\n      else if(line.condition==='measurementRole')condVal=node.role;\n      else if(line.condition==='installationType')condVal=node.installationType;\n      else if(line.condition==='measurementType')condVal=node.measurementType;\n    }\n    if(condVal===undefined||condVal===null||condVal==='')return null;\n  }\n  var text=(line.text||'').replace(/\\$\\{(\\w+)\\}/g,function(m,key){\n    if(key==='entityLabel')return node.entityLabel||node.name||'';\n    if(key==='entityName')return node.entityName||'';\n    if(key==='value')return formatValue(node.value,currentMode);\n    if(key==='unit')return currentMode==='power'?'kW':'kWh';\n    if(key==='measurementRole')return node.role||'';\n    if(key==='installationType')return node.installationType||'';\n    if(key==='measurementType')return node.measurementType||'';\n    return(node.attributes&&node.attributes[key]!==undefined)?String(node.attributes[key]):'';\n  });\n  return{text:text,fontSize:line.fontSize||11,bold:!!line.bold,color:line.color||null};\n}\n\nfunction calculateCardHeight(node){\n  var tpl=getCardTemplate();\n  if(!tpl||tpl.length===0)return 50;\n  var h=16;\n  tpl.forEach(function(line){\n    var resolved=resolveTemplateLine(line,node);\n    if(resolved)h+=resolved.fontSize+4;\n  });\n  return Math.max(40,h);\n}\n\nfunction createCardGraphic(node,cx,cy,w,h,key){\n  var col=getNodeColor(node),dash=node.isVirtual;\n  var tpl=getCardTemplate();\n  var lines=[];\n  if(tpl){\n    tpl.forEach(function(l){\n      var resolved=resolveTemplateLine(l,node);\n      if(resolved)lines.push(resolved);\n    });\n  }\n  var els=[];\n  els.push({type:'rect',shape:{x:cx-w/2,y:cy-h/2,width:w,height:h,r:[8,8,8,8]},style:{fill:dash?'#f5f5f5':col,stroke:dash?COLORS.unmeasured:'rgba(255,255,255,0.3)',lineWidth:dash?2:1,lineDash:dash?[4,4]:null,shadowBlur:6,shadowColor:'rgba(0,0,0,0.15)',opacity:dash?0.8:1},z:10,_nk:key});\n  var textColor=dash?'#666':'#fff';\n  var totalTextH=0;\n  lines.forEach(function(l){totalTextH+=l.fontSize+4;});\n  var startY=cy-totalTextH/2+4;\n  lines.forEach(function(l){\n    els.push({type:'text',style:{x:cx,y:startY+l.fontSize*0.5,text:truncName(l.text,24),textAlign:'center',textVerticalAlign:'middle',fontSize:l.fontSize,fontWeight:l.bold?'bold':'normal',fill:l.color||textColor},z:12,_nk:key});\n    startY+=l.fontSize+4;\n  });\n  return els;\n}\n\nfunction renderFlowPaths(tree){\n  if(!flowSvg)return;\n  while(flowSvg.firstChild)flowSvg.removeChild(flowSvg.firstChild);\n  var s=self.ctx.settings||{},anim=s.showAnimation!==false,dots=s.dotsPerLine||3,minR=s.minFlowRate||0.75,maxR=s.maxFlowRate||6;\n  var ns='http://www.w3.org/2000/svg';\n  var allV=[];collectAllValues(tree,allV);\n  var maxV=allV.length>0?Math.max.apply(null,allV):1;if(maxV===0)maxV=1;\n  drawFlowLines(tree,ns,anim,dots,minR,maxR,maxV);\n}\n\nfunction collectAllValues(n,arr){if(n.value>0)arr.push(n.value);if(n.children)n.children.forEach(function(c){collectAllValues(c,arr);});}\n\nfunction drawFlowLines(node,ns,anim,dots,minR,maxR,maxV){\n  if(!node.children)return;\n  node.children.forEach(function(ch){\n    var fp=nodePositions['n_'+node.id],tp=nodePositions['n_'+ch.id];\n    if(fp&&tp)createFlowLine(ns,fp,tp,ch,anim,dots,minR,maxR,maxV);\n    drawFlowLines(ch,ns,anim,dots,minR,maxR,maxV);\n  });\n}\n\nfunction createFlowLine(ns,fp,tp,node,anim,dots,minR,maxR,maxV){\n  var col=getNodeColor(node),dash=node.isVirtual||node.measurementType==='interpolated',val=node.value||0;\n  var fpn=fp.node,tpn=tp.node;\n  var fy=fp.y,ty=tp.y;\n  if(fpn&&fpn._isCard)fy=fp.y+fpn._h/2;\n  if(tpn&&tpn._isCard)ty=tp.y-tpn._h/2;\n  var dy=ty-fy,midY=fy+dy*0.5,cpOff=Math.abs(tp.x-fp.x)*0.15;\n  var d='M '+fp.x+' '+fy+' C '+fp.x+' '+(midY+cpOff)+', '+tp.x+' '+(midY-cpOff)+', '+tp.x+' '+ty;\n  var path=document.createElementNS(ns,'path');\n  path.setAttribute('d',d);path.setAttribute('fill','none');\n  path.setAttribute('stroke',dash?COLORS.unmeasured:col);\n  path.setAttribute('stroke-width',String(Math.max(1.5,Math.min(3,val/20+1.5))));\n  path.setAttribute('stroke-opacity',dash?'0.2':'0.12');\n  if(dash)path.setAttribute('stroke-dasharray','6,4');\n  flowSvg.appendChild(path);\n  if(anim&&val>0&&!node.isVirtual){\n    var ratio=val/maxV,dur=maxR-(maxR-minR)*ratio;\n    for(var i=0;i<dots;i++){\n      var dot=document.createElementNS(ns,'circle');\n      dot.setAttribute('r',String(Math.max(2,Math.min(3.5,val/20+2))));\n      dot.setAttribute('fill',dash?COLORS.unmeasured:col);dot.setAttribute('opacity','0.6');\n      dot.classList.add('efc-dot');\n      dot.style.offsetPath='path(\"'+d+'\")';\n      dot.style.setProperty('--flow-duration',dur.toFixed(2)+'s');\n      dot.style.animationDelay=((-dur/dots)*i).toFixed(2)+'s';\n      flowSvg.appendChild(dot);\n    }\n  }\n}\n\nfunction navigateToEntity(node){\n  if(!node||!node.entityId)return;\n  var s=self.ctx.settings||{},ts=s.targetState||'';\n  if(ts&&self.ctx.dashboard&&self.ctx.dashboard.stateChanged){\n    self.ctx.dashboard.stateChanged(ts,{entityId:node.entityId,entityName:node.entityName||node.name});\n  }\n}\n\nfunction showError(msg){\n  chart.setOption({graphic:{elements:[{type:'text',style:{x:chartContainer.offsetWidth/2,y:chartContainer.offsetHeight/2,text:msg,textAlign:'center',textVerticalAlign:'middle',fontSize:13,fill:'#f44336'}}]}},true);\n}\n\nself.onResize=function(){if(chart&&chartContainer){chart.resize({width:chartContainer.offsetWidth,height:chartContainer.offsetHeight});if(hierarchyTree)renderNodes(hierarchyTree);}};\nself.onDestroy=function(){if(resizeObserver){resizeObserver.disconnect();resizeObserver=null;}if(chart){chart.dispose();chart=null;}};\nself.typeParameters=function(){return{previewWidth:'100%',previewHeight:'100%',embedTitlePanel:false,hasDataExportAction:false,maxDatasources:-1,maxDataKeys:-1,dataKeysOptional:true,datasourcesOptional:false,hasAdditionalLatestDataKeys:true,singleEntity:true};};\n",
    "settingsSchema": {
      "schema": {
        "type": "object",
        "title": "Energy Flow Card Settings",
        "properties": {
          "relationType": {
            "title": "Relation Type",
            "type": "string",
            "default": "MeasurementHierarchy"
          },
          "powerAttribute": {
            "title": "Power Attribute",
            "type": "string",
            "default": "P_th_kW"
          },
          "energyAttribute": {
            "title": "Energy Attribute",
            "type": "string",
            "default": "E_th_kWh"
          },
          "weightAttribute": {
            "title": "Interpolation Weight Attribute",
            "type": "string",
            "default": "interpolationWeight"
          },
          "targetState": {
            "title": "Target Dashboard State",
            "type": "string",
            "default": ""
          },
          "defaultMode": {
            "title": "Default Mode",
            "type": "string",
            "default": "power"
          },
          "showToolbar": {
            "title": "Show Toolbar",
            "type": "boolean",
            "default": true
          },
          "showAnimation": {
            "title": "Show Flow Animation",
            "type": "boolean",
            "default": true
          },
          "minFlowRate": {
            "title": "Min Flow Duration (s) - fastest",
            "type": "number",
            "default": 0.75,
            "minimum": 0.3,
            "maximum": 3
          },
          "maxFlowRate": {
            "title": "Max Flow Duration (s) - slowest",
            "type": "number",
            "default": 6,
            "minimum": 2,
            "maximum": 15
          },
          "dotsPerLine": {
            "title": "Dots per Flow Line",
            "type": "number",
            "default": 3,
            "minimum": 1,
            "maximum": 8
          },
          "showTimewindowSelector": {
            "title": "Show Timewindow Selector",
            "type": "boolean",
            "default": true
          },
          "twSelectorColor": {
            "title": "Timewindow Selector Color",
            "type": "string",
            "default": ""
          },
          "twSelectorPosition": {
            "title": "Timewindow Selector Position",
            "type": "string",
            "default": "center"
          },
          "twSelectorDefaultMode": {
            "title": "Timewindow Default Mode",
            "type": "string",
            "default": "month"
          },
          "twCustomStartTime": {
            "title": "Custom Start Time",
            "type": "string",
            "default": ""
          },
          "twCustomEndTime": {
            "title": "Custom End Time",
            "type": "string",
            "default": ""
          },
          "heatingColor": {
            "title": "Heating Color",
            "type": "string",
            "default": "#f44336"
          },
          "coolingColor": {
            "title": "Cooling Color",
            "type": "string",
            "default": "#2196f3"
          },
          "unmeasuredColor": {
            "title": "Unmeasured Color",
            "type": "string",
            "default": "#9e9e9e"
          },
          "generatorColor": {
            "title": "Generator Color",
            "type": "string",
            "default": "#4caf50"
          },
          "generatorIcon": {
            "title": "Generator Icon",
            "type": "string",
            "default": "bolt"
          },
          "subDistributionIcon": {
            "title": "Sub-Distribution Icon",
            "type": "string",
            "default": "device_hub"
          },
          "circuitIcon": {
            "title": "Circuit Icon",
            "type": "string",
            "default": "thermostat"
          },
          "unmeasuredIcon": {
            "title": "Unmeasured Icon",
            "type": "string",
            "default": "calculate"
          },
          "labelMode": {
            "title": "Node Label Mode",
            "type": "string",
            "default": "auto"
          },
          "cardTemplate": {
            "title": "Card Template (JSON)",
            "type": "string",
            "default": ""
          }
        },
        "required": []
      },
      "form": [
        [
          "relationType",
          "powerAttribute",
          "energyAttribute",
          "weightAttribute",
          "targetState",
          {
            "key": "defaultMode",
            "type": "rc-select",
            "multiple": false,
            "items": [
              {
                "value": "power",
                "label": "Power (kW)"
              },
              {
                "value": "energy",
                "label": "Energy (kWh)"
              }
            ]
          }
        ],
        [
          "showToolbar",
          "showAnimation",
          "dotsPerLine",
          "minFlowRate",
          "maxFlowRate"
        ],
        [
          "showTimewindowSelector",
          {
            "key": "twSelectorColor",
            "type": "color",
            "condition": "model.showTimewindowSelector === true"
          },
          {
            "key": "twSelectorPosition",
            "type": "rc-select",
            "multiple": false,
            "items": [
              {
                "value": "left",
                "label": "Left"
              },
              {
                "value": "center",
                "label": "Center"
              },
              {
                "value": "right",
                "label": "Right"
              }
            ],
            "condition": "model.showTimewindowSelector === true"
          },
          {
            "key": "twSelectorDefaultMode",
            "type": "rc-select",
            "multiple": false,
            "items": [
              {
                "value": "day",
                "label": "Day"
              },
              {
                "value": "week",
                "label": "Week"
              },
              {
                "value": "month",
                "label": "Month"
              },
              {
                "value": "custom",
                "label": "Custom"
              }
            ],
            "condition": "model.showTimewindowSelector === true"
          },
          {
            "key": "twCustomStartTime",
            "condition": "model.showTimewindowSelector === true"
          },
          {
            "key": "twCustomEndTime",
            "condition": "model.showTimewindowSelector === true"
          }
        ],
        [
          {
            "key": "heatingColor",
            "type": "color"
          },
          {
            "key": "coolingColor",
            "type": "color"
          },
          {
            "key": "unmeasuredColor",
            "type": "color"
          },
          {
            "key": "generatorColor",
            "type": "color"
          }
        ],
        [
          {
            "key": "generatorIcon",
            "type": "icon"
          },
          {
            "key": "subDistributionIcon",
            "type": "icon"
          },
          {
            "key": "circuitIcon",
            "type": "icon"
          },
          {
            "key": "unmeasuredIcon",
            "type": "icon"
          }
        ],
        [
          {
            "key": "labelMode",
            "type": "rc-select",
            "multiple": false,
            "items": [
              {
                "value": "auto",
                "label": "Auto (Circles)"
              },
              {
                "value": "custom",
                "label": "Custom (Cards)"
              }
            ]
          },
          {
            "key": "cardTemplate",
            "type": "textarea",
            "placeholder": "[{\"text\":\"${entityLabel}\",\"fontSize\":13,\"bold\":true},{\"text\":\"${value} ${unit}\",\"fontSize\":12,\"bold\":true}]",
            "condition": "model.labelMode === 'custom'"
          }
        ]
      ],
      "groupInfoes": [
        {
          "formIndex": 0,
          "GroupTitle": "Data Settings"
        },
        {
          "formIndex": 1,
          "GroupTitle": "Layout & Animation"
        },
        {
          "formIndex": 2,
          "GroupTitle": "Timewindow Selector"
        },
        {
          "formIndex": 3,
          "GroupTitle": "Colors"
        },
        {
          "formIndex": 4,
          "GroupTitle": "Node Icons (Material Design)"
        },
        {
          "formIndex": 5,
          "GroupTitle": "Node Labels"
        }
      ]
    },
    "dataKeySettingsSchema": {},
    "latestDataKeySettingsSchema": {},
    "defaultConfig": "{\"datasources\":[{\"type\":\"entity\",\"dataKeys\":[{\"name\":\"P_th_kW\",\"type\":\"timeseries\",\"label\":\"Power\",\"color\":\"#2196f3\",\"settings\":{}},{\"name\":\"E_th_kWh\",\"type\":\"timeseries\",\"label\":\"Energy\",\"color\":\"#4caf50\",\"settings\":{}}],\"latestDataKeys\":[{\"name\":\"startTimeMs\",\"type\":\"attribute\",\"label\":\"Start Time\",\"settings\":{}},{\"name\":\"endTimeMs\",\"type\":\"attribute\",\"label\":\"End Time\",\"settings\":{}}]}],\"timewindow\":{\"hideInterval\":false,\"hideLastInterval\":false,\"hideQuickInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":0,\"realtime\":{\"realtimeType\":0,\"timewindowMs\":3600000,\"quickInterval\":\"CURRENT_HOUR\",\"interval\":5000},\"aggregation\":{\"type\":\"AVG\",\"limit\":25000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"relationType\":\"MeasurementHierarchy\",\"powerAttribute\":\"P_th_kW\",\"energyAttribute\":\"E_th_kWh\",\"weightAttribute\":\"interpolationWeight\",\"targetState\":\"\",\"defaultMode\":\"power\",\"showToolbar\":true,\"showAnimation\":true,\"minFlowRate\":0.75,\"maxFlowRate\":6,\"dotsPerLine\":3,\"showTimewindowSelector\":true,\"twSelectorColor\":\"\",\"twSelectorPosition\":\"center\",\"twSelectorDefaultMode\":\"month\",\"twCustomStartTime\":\"\",\"twCustomEndTime\":\"\",\"heatingColor\":\"#f44336\",\"coolingColor\":\"#2196f3\",\"unmeasuredColor\":\"#9e9e9e\",\"generatorColor\":\"#4caf50\",\"labelMode\":\"auto\",\"cardTemplate\":\"\"},\"title\":\"Energy Flow Card\",\"dropShadow\":true,\"enableFullscreen\":true,\"useDashboardTimewindow\":true,\"displayTimewindow\":true,\"hasAdditionalLatestDataKeys\":true}"
  },
  "tags": [
    "chart",
    "latest",
    "energy",
    "flow",
    "animation",
    "hierarchy",
    "hvac",
    "echarts",
    "power",
    "measurement"
  ]
}