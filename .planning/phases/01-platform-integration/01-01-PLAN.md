---
phase: 01-platform-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - widgets/src/eco_timeseries_zoom_sync.js
  - widgets/types/eco_timeseries_zoom_sync.json
autonomous: true

must_haves:
  truths:
    - "Widget displays multiple datasources with individual stats cards"
    - "Chart supports line, bar, area, scatter types"
    - "Legend can be positioned top/bottom/left/right with alignment"
    - "Stats cards show configurable values (current, min, max, mean, median, sum, count)"
    - "Dual Y-axes work for different units"
    - "ECharts toolbox has configurable visibility per feature"
    - "Color settings use ThingsBoard color picker"
  artifacts:
    - path: "widgets/src/eco_timeseries_zoom_sync.js"
      provides: "Widget controller source code"
      min_lines: 400
    - path: "widgets/types/eco_timeseries_zoom_sync.json"
      provides: "Complete widget definition with settings schema"
      contains: "type.*color"
  key_links:
    - from: "widgets/types/eco_timeseries_zoom_sync.json"
      to: "widgets/src/eco_timeseries_zoom_sync.js"
      via: "controllerScript contains minified source"
      pattern: "renderStatsCard"
---

<objective>
Implement eco_timeseries_zoom_sync widget with full platform integration.

Purpose: Create reference implementation for all other widgets, demonstrating ThingsBoard card-level patterns, color pickers, stats cards, and proper typeParameters configuration.

Output: Complete widget source (JS) and definition (JSON) ready for sync to ThingsBoard.
</objective>

<execution_context>
@/Users/jiridockal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jiridockal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-platform-integration/01-CONTEXT.md
@widgets/src/eco_load_duration_curve.js (reference implementation for patterns)
@widgets/types/eco_timeseries_zoom_sync.json (current state to update)
@CLAUDE.md (development patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create widget source file</name>
  <files>widgets/src/eco_timeseries_zoom_sync.js</files>
  <action>
Create complete widget controller implementing all features from 01-CONTEXT.md decisions.

**Structure (follow eco_load_duration_curve.js pattern):**
1. Variable declarations (chart, chartContainer, statsCardContainers)
2. self.onInit - initialize containers and chart
3. self.onDataUpdated - call updateChart
4. updateChart() - main rendering function
5. renderStatsCard() - DOM-based stats card rendering (copy pattern from eco_load_duration_curve)
6. buildChartOption() - ECharts configuration builder
7. Helper functions (adjustColor, calculateStatistics, formatValue)
8. self.onResize, self.onDestroy
9. self.typeParameters - return embedTitlePanel: false, hasDataExportAction: true

**Key Features to Implement:**
- Chart types: line, bar, area, scatter (use rc-select in settings)
- Multi-series support: iterate self.ctx.data array, each datasource gets own series
- Stats cards: one card per dataKey, show configurable statistics
- Dual Y-axes: yAxisIndex assignment based on series config or auto-detect units
- Legend: classic (ECharts native) vs card (DOM-based stats card)
- Toolbox: saveAsImage, dataView, dataZoom, restore with visibility toggles
- DataZoom: inside (brush) + optional slider, NO dashboard sync (internal only)

**Settings to read from self.ctx.settings:**
- chartType: 'line' | 'bar' | 'area' | 'scatter'
- showLegend, legendStyle, legendPosition, legendAlign
- legendCardColorMode, legendCardColor
- legendValues: array of ['current', 'min', 'max', 'mean', 'median', 'sum', 'count']
- showTimestamp, timestampFormat
- showDataZoomSlider
- yAxisMin, yAxisMax, yAxis2Min, yAxis2Max
- showToolbox, showSaveAsImage, showDataView, showDataZoom, showRestore

**Do NOT implement:**
- Dashboard zoom sync (deferred per CONTEXT.md)
- Custom aggregation functions (e.g., calculateMovingAverage, custom window averaging)
  - Widget uses platform data as-is from self.ctx.data
  - Platform handles aggregation via timewindow server-side (PLAT-03)
  </action>
  <verify>
File exists at widgets/src/eco_timeseries_zoom_sync.js with 400+ lines.
Contains: renderStatsCard, buildChartOption, self.typeParameters, hasDataExportAction.
Does NOT contain: calculateMovingAverage, windowAverage, custom aggregation functions (confirms PLAT-03 compliance).
  </verify>
  <done>
Complete widget source file with all features from CONTEXT.md decisions implemented, using platform aggregation only.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update widget JSON definition</name>
  <files>widgets/types/eco_timeseries_zoom_sync.json</files>
  <action>
Update the widget JSON with new templateHtml, settingsSchema, and controllerScript.

**1. Update templateHtml:**
Use wrapper pattern from eco_load_duration_curve:
```html
<div id="widget-wrapper" style="width: 100%; height: 100%; display: flex; flex-direction: column;">
  <div id="stats-card-top" style="padding: 4px 8px; display: none;"></div>
  <div style="flex: 1; min-height: 0; display: flex;">
    <div id="stats-card-left" style="padding: 4px; display: none;"></div>
    <div id="chart-container" style="flex: 1; min-height: 0;"></div>
    <div id="stats-card-right" style="padding: 4px; display: none;"></div>
  </div>
  <div id="stats-card-bottom" style="padding: 4px 8px; display: none;"></div>
</div>
```

**2. Update settingsSchema.schema.properties:**
Add ALL settings with proper types:
- chartType: string, enum, default "line"
- showLegend: boolean, default true
- legendStyle: string, enum ["classic", "card"], default "classic"
- legendPosition: string, enum ["top", "bottom", "left", "right"], default "bottom"
- legendAlign: string, enum ["left", "center", "right"], default "center"
- legendCardColorMode: string, enum ["auto", "manual", "gradient"], default "auto"
- legendCardColor: string, default "#2196F3" (color picker)
- legendValues: array of strings, default ["current"]
- showTimestamp: boolean, default true
- timestampFormat: string, default "YYYY-MM-DD HH:mm:ss"
- showDataZoomSlider: boolean, default true
- smoothLine: boolean, default true
- yAxisMin, yAxisMax, yAxis2Min, yAxis2Max: number (optional)
- showToolbox: boolean, default true
- showSaveAsImage, showDataView, showDataZoom, showRestore: boolean, all default true

**3. Update settingsSchema.form:**
Use proper form types with conditions:
- chartType: rc-select with items
- legendStyle: rc-select, condition: model.showLegend
- legendPosition: rc-select, condition: model.showLegend
- legendAlign: rc-select, condition: model.showLegend && model.legendStyle === 'card'
- legendCardColorMode: rc-select, condition: model.showLegend && model.legendStyle === 'card'
- legendCardColor: type "color", condition: model.legendCardColorMode === 'manual'
- legendValues: checkboxes with titleMap
- Toolbox settings with conditions: model.showToolbox

**4. Update defaultConfig:**
Include settings defaults, timewindow config, enableFullscreen: true, useDashboardTimewindow: true

**5. Update controllerScript:**
Read the JS source from widgets/src/eco_timeseries_zoom_sync.js, escape it properly, and set as controllerScript value.
  </action>
  <verify>
JSON is valid (parse with jq or node -e).
settingsSchema.schema.properties includes legendCardColor.
settingsSchema.form includes {"type": "color"} entry.
controllerScript contains "renderStatsCard".
  </verify>
  <done>
Widget JSON fully updated with new template, settings schema with color pickers, and embedded controllerScript.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `node -e "JSON.parse(require('fs').readFileSync('widgets/types/eco_timeseries_zoom_sync.json'))"` - no parse error
2. `grep -c "type.*color" widgets/types/eco_timeseries_zoom_sync.json` returns >= 1
3. `grep -c "renderStatsCard" widgets/src/eco_timeseries_zoom_sync.js` returns >= 1
4. `wc -l widgets/src/eco_timeseries_zoom_sync.js` returns 400+
5. `grep -c "calculateMovingAverage\|windowAverage" widgets/src/eco_timeseries_zoom_sync.js` returns 0 (PLAT-03 compliance)
</verification>

<success_criteria>
- Widget source file created with all CONTEXT.md features
- Widget JSON updated with color picker settings and new template
- Both files are syntactically valid
- Widget uses platform aggregation only (no custom aggregation functions)
- Ready for sync to ThingsBoard
</success_criteria>

<output>
After completion, create `.planning/phases/01-platform-integration/01-01-SUMMARY.md`
</output>
