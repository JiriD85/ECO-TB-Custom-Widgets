---
phase: 01-platform-integration
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - CLAUDE.md
autonomous: false

must_haves:
  truths:
    - "CLAUDE.md documents multi-series stats card pattern"
    - "CLAUDE.md documents dual Y-axis configuration"
    - "CLAUDE.md documents toolbox visibility settings pattern"
    - "Widget syncs to ThingsBoard without errors"
    - "Widget preview displays sample data correctly"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Widget development documentation"
      contains: "Multi-Series Stats Card"
  key_links:
    - from: "CLAUDE.md"
      to: "widgets/src/eco_timeseries_zoom_sync.js"
      via: "documents patterns used"
      pattern: "eco_timeseries_zoom_sync"
---

<objective>
Document widget patterns and verify ThingsBoard integration.

Purpose: Create reusable reference documentation for future widget development and validate the implementation works on the target platform.

Output: Updated CLAUDE.md with new patterns, verified working widget on ThingsBoard.
</objective>

<execution_context>
@/Users/jiridockal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jiridockal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-platform-integration/01-01-SUMMARY.md
@widgets/src/eco_timeseries_zoom_sync.js
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CLAUDE.md with widget patterns</name>
  <files>CLAUDE.md</files>
  <action>
Add new sections to CLAUDE.md documenting the patterns implemented in eco_timeseries_zoom_sync.

**Add these sections after "Common Issues & Solutions":**

### Multi-Series Stats Card Pattern

When widget displays multiple datasources/dataKeys, each series gets its own stats card:

```javascript
// Iterate all datasources and dataKeys
var allSeries = [];
for (var i = 0; i < self.ctx.data.length; i++) {
    var ds = self.ctx.data[i];
    var dataKey = ds.dataKey || {};
    var color = dataKey.color || getDefaultColor(i);

    allSeries.push({
        label: dataKey.label || dataKey.name,
        color: color,
        values: ds.data.map(function(d) { return d[1]; }),
        lastTimestamp: ds.data.length ? ds.data[ds.data.length - 1][0] : null
    });
}

// Render card for each series
allSeries.forEach(function(series) {
    var stats = calculateStatistics(series.values);
    renderSingleCard(container, series, stats, config);
});
```

### Dual Y-Axis Configuration

For widgets with different units (e.g., temperature + humidity):

```javascript
// Detect if dual axes needed based on units
var unitGroups = {};
allSeries.forEach(function(s, i) {
    var unit = s.units || '';
    if (!unitGroups[unit]) unitGroups[unit] = [];
    unitGroups[unit].push(i);
});

var needsDualAxis = Object.keys(unitGroups).length === 2;

// Configure Y axes
var yAxes = [{
    type: 'value',
    name: firstUnit,
    position: 'left'
}];

if (needsDualAxis) {
    yAxes.push({
        type: 'value',
        name: secondUnit,
        position: 'right'
    });
}

// Assign yAxisIndex to each series
series.forEach(function(s, i) {
    s.yAxisIndex = unitGroups[s.units].includes(i) && needsDualAxis ? 1 : 0;
});
```

### Toolbox Visibility Settings

Configure ECharts toolbox with granular visibility:

```javascript
var toolboxConfig = {
    show: settings.showToolbox !== false,
    right: 10,
    top: 5,
    feature: {
        saveAsImage: {
            show: settings.showSaveAsImage !== false,
            title: 'Save as PNG',
            pixelRatio: 2
        },
        dataView: {
            show: settings.showDataView !== false,
            title: 'Data View',
            readOnly: true
        },
        dataZoom: {
            show: settings.showDataZoom !== false,
            title: { zoom: 'Zoom', back: 'Reset' }
        },
        restore: {
            show: settings.showRestore !== false,
            title: 'Restore'
        }
    }
};
```

Settings schema pattern:
```json
"showToolbox": { "type": "boolean", "default": true },
"showSaveAsImage": { "type": "boolean", "default": true },
"showDataView": { "type": "boolean", "default": true },
"showDataZoom": { "type": "boolean", "default": true },
"showRestore": { "type": "boolean", "default": true }
```

Form with conditions:
```json
{ "key": "showSaveAsImage", "condition": "model.showToolbox === true" },
{ "key": "showDataView", "condition": "model.showToolbox === true" },
{ "key": "showDataZoom", "condition": "model.showToolbox === true" },
{ "key": "showRestore", "condition": "model.showToolbox === true" }
```

### Reference Widget

**eco_timeseries_zoom_sync** serves as the reference implementation for:
- Multi-series data handling
- Statistics cards with flexible positioning
- Dual Y-axis auto-detection
- Toolbox with granular settings
- Card-level platform integration (hasDataExportAction)

Source: `widgets/src/eco_timeseries_zoom_sync.js`
  </action>
  <verify>
CLAUDE.md contains "Multi-Series Stats Card Pattern".
CLAUDE.md contains "Dual Y-Axis Configuration".
CLAUDE.md contains "Toolbox Visibility Settings".
CLAUDE.md contains "Reference Widget".
  </verify>
  <done>
CLAUDE.md updated with all new widget patterns from eco_timeseries_zoom_sync implementation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sync widget to ThingsBoard</name>
  <files></files>
  <action>
Run the sync command to upload the updated widget to ThingsBoard:

```bash
cd /Users/jiridockal/development/ECO-TB-Custom-Widgets
node sync/sync.js sync
```

This will:
1. Create a backup of current server state
2. Upload updated eco_timeseries_zoom_sync.json
3. Report success/failure

If sync fails due to authentication, note the error for user action.
  </action>
  <verify>
Sync command completes successfully OR returns auth error (note for user action).
Output shows eco_timeseries_zoom_sync was uploaded, or auth error is clearly identified for user to resolve.
  </verify>
  <done>
Widget successfully synced to ThingsBoard server, or auth issue identified for user resolution.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete eco_timeseries_zoom_sync widget with:
- Multi-series support with individual stats cards
- Chart types: line, bar, area, scatter
- Legend positioning (top/bottom/left/right) with alignment
- Stats cards showing configurable values
- Dual Y-axis support
- ECharts toolbox with visibility settings
- Color picker for card colors
  </what-built>
  <how-to-verify>
1. Open ThingsBoard dashboard editor
2. Add eco_timeseries_zoom_sync widget to a test dashboard
3. Configure with 2 datasources (different units if possible)
4. Test settings:
   - Change chart type (line -> bar -> area)
   - Enable legend style "card"
   - Position legend in different positions
   - Enable multiple legend values (min, max, mean)
   - Test color picker for card color
   - Toggle toolbox features
5. Verify dual Y-axis appears with different unit datasources
6. Verify stats cards update when data changes
  </how-to-verify>
  <resume-signal>
Type "verified" if widget works correctly, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. CLAUDE.md has new pattern sections
2. Widget visible in ThingsBoard widget library
3. User verified widget functionality
</verification>

<success_criteria>
- Documentation updated with reusable patterns
- Widget synced to ThingsBoard
- User confirms widget displays data correctly with all settings working
</success_criteria>

<output>
After completion, create `.planning/phases/01-platform-integration/01-02-SUMMARY.md`
</output>
